<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Quiz Control Hub</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="library">
  <div class="glow"></div>
  <header class="hero">
    <div>
      <p class="eyebrow">Quiz console</p>
      <h1>Pick a quiz, share the code, and get playing</h1>
      <p class="lede">A hub to browse everything you've created, launch a live session, and send learners to the right join page.</p>
      <div class="cta-row">
        <a class="button" href="/create.html">Create a new quiz</a>
        <a class="button ghost" href="/run.html">Run an existing quiz</a>
        <a class="button ghost" href="/join.html">Player join page</a>
      </div>
    </div>
    <div class="hero-card">
      <h2>Quick start</h2>
      <ol>
        <li>Build a quiz in <strong>Create</strong>.</li>
        <li>Open <strong>Run</strong> with your quiz code to control the game.</li>
        <li>Send players to <strong>Join</strong> to enter the quiz code.</li>
      </ol>
    </div>
  </header>

  <main class="library-grid">
    <section class="card" id="strictness-card">
      <div class="card-heading">
        <div>
          <p class="eyebrow">Answer grading</p>
          <h2>Answer grading strictness</h2>
          <p class="muted" id="strictness-summary">Loading strictness settings…</p>
        </div>
      </div>
      <div class="strictness-row">
        <div>
          <p class="eyebrow">Current mode</p>
          <div class="strictness-pill" id="strictness-pill">Normal</div>
        </div>
        <div class="muted" id="strictness-llm">LLM fallback: —</div>
      </div>
      <div class="strictness-details">
        <h3>Acceptance criteria for OK</h3>
        <ul id="strictness-ok" class="criteria-list"></ul>
        <h3>Partial credit behavior</h3>
        <ul id="strictness-partial" class="criteria-list"></ul>
      </div>
      <p class="muted" id="strictness-rules"></p>
    </section>

    <section class="card">
      <div class="card-heading">
        <div>
          <p class="eyebrow">Library</p>
          <h2>Your quizzes (newest first)</h2>
          <p class="muted">Created quizzes stay here in chronological order so you can relaunch them quickly.</p>
        </div>
        <div class="cta-row">
          <button type="button" id="import-apkg" class="button ghost">Import .apkg</button>
          <button type="button" id="refresh-library" class="ghost">Refresh</button>
        </div>
      </div>
      <p id="import-status" class="muted" style="display:none;"></p>
      <ul id="quiz-list" class="quiz-list"></ul>
      <p id="empty-state" class="muted">No quizzes yet. Create one to see it appear here.</p>
      <input type="file" id="apkg-input" accept=".apkg" style="display:none;" />
    </section>
  </main>

  <script>
    const quizList = document.getElementById('quiz-list');
    const emptyState = document.getElementById('empty-state');
    const refreshBtn = document.getElementById('refresh-library');
    const importBtn = document.getElementById('import-apkg');
    const apkgInput = document.getElementById('apkg-input');
    const importStatus = document.getElementById('import-status');
    const strictnessSummary = document.getElementById('strictness-summary');
    const strictnessPill = document.getElementById('strictness-pill');
    const strictnessOk = document.getElementById('strictness-ok');
    const strictnessPartial = document.getElementById('strictness-partial');
    const strictnessLlm = document.getElementById('strictness-llm');
    const strictnessRules = document.getElementById('strictness-rules');
    let isImporting = false;

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }

    function renderQuizList(quizzes) {
      quizList.innerHTML = '';
      if (!quizzes.length) {
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';
      quizzes.forEach((quiz) => {
        const item = document.createElement('li');
        item.className = 'quiz-row';
        item.innerHTML = `
          <div>
            <p class="eyebrow">${quiz.id}</p>
            <h3>${quiz.title}</h3>
            <p class="muted">${quiz.questionCount} question${quiz.questionCount === 1 ? '' : 's'} · Created ${formatDate(quiz.createdAt)}</p>
          </div>
          <div class="quiz-actions">
            <a class="button ghost" href="/run.html?quizId=${quiz.id}">Run</a>
            <a class="button ghost" href="/homework.html?quizId=${quiz.id}">Assign as homework</a>
            <button type="button" class="button danger delete" data-id="${quiz.id}">Delete</button>
            <button type="button" class="copy" data-code="${quiz.id}">Copy code</button>
          </div>
        `;
        quizList.appendChild(item);
      });
      quizList.querySelectorAll('.copy').forEach((button) => {
        button.addEventListener('click', () => {
          navigator.clipboard.writeText(button.dataset.code);
          button.textContent = 'Copied!';
          setTimeout(() => { button.textContent = 'Copy code'; }, 1200);
        });
      });
      quizList.querySelectorAll('.delete').forEach((button) => {
        button.addEventListener('click', async () => {
          const id = button.dataset.id;
          if (!confirm(`Delete quiz ${id}? This will remove it and any homework/live sessions created from it.`)) return;

          button.disabled = true;
          try {
            const resp = await fetch(`/api/quizzes/${id}`, { method: 'DELETE' });
            if (!resp.ok) {
              const data = await resp.json().catch(() => ({}));
              alert(data.error || 'Failed to delete quiz.');
            }
          } catch (e) {
            alert('Failed to delete quiz.');
          } finally {
            await loadQuizzes();
          }
        });
      });
    }

    const strictnessCopy = {
      strict: {
        title: 'Strict',
        summary: 'Exact normalized answers only. No synonyms, typo tolerance, or LLM fallback.',
        ok: [
          'Exact normalized match (case, punctuation, and diacritics ignored).',
          'Compact match (ignores spacing/hyphenation, e.g. "well-known" = "well known").',
        ],
        partial: [
          'Only explicit partial answers configured on the question.',
          'No synonym or typo-based partial credit.',
        ],
      },
      normal: {
        title: 'Normal',
        summary: 'Balanced matching with typo tolerance, synonyms, substrings, and LLM fallback.',
        ok: [
          'Exact normalized match plus compact match.',
          'Near-duplicate answers can still count as OK via close-match rules.',
        ],
        partial: [
          'Explicit partial answers.',
          'Synonyms and close matches may earn partial credit.',
        ],
      },
      lenient: {
        title: 'Lenient',
        summary: 'More forgiving matching with extra typo tolerance and LLM fallback.',
        ok: [
          'Exact normalized match plus compact match.',
          'More typo tolerance and close matches accepted.',
        ],
        partial: [
          'Explicit partial answers.',
          'Synonyms and close matches more likely to earn partial credit.',
        ],
      },
    };

    function renderStrictnessDetails(payload) {
      const strictness = payload?.strictness || 'normal';
      const copy = strictnessCopy[strictness] || strictnessCopy.normal;
      strictnessSummary.textContent = copy.summary;
      strictnessPill.textContent = copy.title;

      strictnessOk.innerHTML = '';
      copy.ok.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        strictnessOk.appendChild(li);
      });

      strictnessPartial.innerHTML = '';
      copy.partial.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        strictnessPartial.appendChild(li);
      });

      const ruleConfig = payload?.ruleConfig || {};
      const llmDefaults = payload?.llmDefaults || {};
      const closeMatch = ruleConfig.allowCloseMatch
        ? `Close-match threshold: ${(ruleConfig.closeMatchThreshold ?? 0.8).toFixed(2)}`
        : 'Close-match disabled';
      const synonyms = ruleConfig.allowSynonyms ? 'Synonyms enabled' : 'Synonyms disabled';
      const substrings = ruleConfig.allowSubstrings ? 'Substring checks enabled' : 'Substring checks disabled';
      const compact = ruleConfig.allowCompactMatch ? 'Compact match enabled' : 'Compact match disabled';
      strictnessRules.textContent = `Rules: ${compact} · ${closeMatch} · ${synonyms} · ${substrings}`;

      if (ruleConfig.allowLLMFallback) {
        strictnessLlm.textContent = `LLM fallback: enabled (${llmDefaults.mode} mode, confidence ≥ ${(llmDefaults.confidenceThreshold ?? 0.8).toFixed(2)})`;
      } else {
        strictnessLlm.textContent = 'LLM fallback: disabled (strict mode)';
      }
    }

    async function loadQuizzes() {
      try {
        const response = await fetch('/api/quizzes');
        const data = await response.json();
        renderQuizList(data);
      } catch (error) {
        emptyState.textContent = 'Unable to load quizzes right now.';
        emptyState.style.display = 'block';
      }
    }

    function setImportStatus(message, isError = false) {
      importStatus.textContent = message;
      importStatus.style.color = isError ? '#e24a68' : 'var(--muted)';
      importStatus.style.display = message ? 'block' : 'none';
    }

    importBtn.addEventListener('click', () => {
      if (isImporting) return;
      apkgInput.click();
    });

    apkgInput.addEventListener('change', async (event) => {
      const file = event.target.files?.[0];
      event.target.value = '';
      if (!file) return;
      isImporting = true;
      setImportStatus(`Importing ${file.name}...`);
      importBtn.disabled = true;
      refreshBtn.disabled = true;
      try {
        const formData = new FormData();
        formData.append('apkg', file);
        const response = await fetch('/api/quizzes/import/apkg', {
          method: 'POST',
          body: formData,
        });
        if (!response.ok) {
          const data = await response.json().catch(() => ({}));
          const errorMessage = data?.error || `Import failed (${response.status}).`;
          setImportStatus(errorMessage, true);
          alert(errorMessage);
          return;
        }
        const payload = await response.json();
        const createdCount = payload.created?.length || 0;
        const templateIds = (payload.created || []).map((item) => item.id).join(', ');
        setImportStatus(
          createdCount
            ? `Imported ${createdCount} template${createdCount === 1 ? '' : 's'}${templateIds ? ` (${templateIds})` : ''}.`
            : 'No quizzes were created.',
        );
        await loadQuizzes();
      } catch (error) {
        setImportStatus('Unable to import right now.', true);
      } finally {
        isImporting = false;
        importBtn.disabled = false;
        refreshBtn.disabled = false;
      }
    });

    refreshBtn.addEventListener('click', loadQuizzes);
    loadQuizzes();

    fetch('/api/settings/answer-strictness')
      .then((response) => response.json())
      .then((payload) => renderStrictnessDetails(payload))
      .catch(() => {
        strictnessSummary.textContent = 'Unable to load strictness settings right now.';
      });
  </script>
</body>
</html>
