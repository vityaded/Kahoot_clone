<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Live Game</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="player-view">
  <div class="glow"></div>
  <main class="player-container">
    <div class="player-status" id="lobby-status">Connecting to the game...</div>
    <p id="join-error" class="error"></p>

    <section class="question-board">
      <div class="corner-badge" id="question-progress">Waiting for host...</div>
      <div class="corner-badge timer" id="timer">--</div>
      <div class="question-content">
        <p class="eyebrow">Question</p>
        <h1 id="question-text">Waiting for the host to start...</h1>
        <div class="media-preview" id="question-media"></div>
      </div>
    </section>

    <section class="response-panel">
      <form id="answer-form" class="answer-card hidden">
        <label>
          Type your answer
          <input type="text" id="answer-input" autocomplete="off" />
        </label>
        <button type="submit">Submit answer</button>
      </form>

      <div id="submission-status" class="card submission-card hidden" aria-live="polite">
        <p id="submission-label" class="eyebrow">Submission</p>
        <p id="submission-answer" class="submitted-answer"></p>
        <p id="submission-correct" class="muted"></p>
      </div>

      <div class="card leaderboard-card" id="leaderboard-card">
        <div class="leaderboard-header">
          <h2>Leaderboard</h2>
          <p class="muted">Live rankings</p>
        </div>
        <p id="answer-feedback"></p>
        <ul id="leaderboard"></ul>
      </div>
    </section>
  </main>

  <div id="leaderboard-overlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="leaderboard-header">
        <h2>Leaderboard</h2>
        <p id="overlay-hint" class="muted"></p>
      </div>
      <ul id="overlay-leaderboard"></ul>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const lobbyStatus = document.getElementById('lobby-status');
    const joinError = document.getElementById('join-error');
    const questionText = document.getElementById('question-text');
    const timerEl = document.getElementById('timer');
    const answerForm = document.getElementById('answer-form');
    const answerInput = document.getElementById('answer-input');
    const submitButton = answerForm.querySelector('button');
    const answerFeedback = document.getElementById('answer-feedback');
    const leaderboard = document.getElementById('leaderboard');
    const questionMedia = document.getElementById('question-media');
    const questionProgress = document.getElementById('question-progress');
    const overlay = document.getElementById('leaderboard-overlay');
    const overlayList = document.getElementById('overlay-leaderboard');
    const overlayHint = document.getElementById('overlay-hint');
    const leaderboardCard = document.getElementById('leaderboard-card');
    const submissionCard = document.getElementById('submission-status');
    const submissionLabel = document.getElementById('submission-label');
    const submissionAnswer = document.getElementById('submission-answer');
    const submissionCorrect = document.getElementById('submission-correct');

    const playerIdFromStorage = localStorage.getItem('playerId');
    let storedPlayerId = playerIdFromStorage;
    let storedQuiz = localStorage.getItem('quizCode');
    let storedName = localStorage.getItem('playerName');

    function generatePlayerId() {
      if (window.crypto?.randomUUID) return window.crypto.randomUUID();
      return Math.random().toString(36).slice(2, 12);
    }

    if (!storedPlayerId) {
      storedPlayerId = generatePlayerId();
      localStorage.setItem('playerId', storedPlayerId);
    }

    let currentQuizId = null;
    let timerInterval = null;
    let lobbyCountdown = null;
    let hasJoinedOnce = Boolean(playerIdFromStorage);
    let lastSubmittedAnswer = '';

    function joinQuiz(message = 'Joining game...') {
      storedName = localStorage.getItem('playerName');
      storedQuiz = localStorage.getItem('quizCode');

      if (!storedName || !storedQuiz) {
        window.location.href = '/join.html';
        return;
      }

      lobbyStatus.textContent = message;
      socket.emit('player:join', {
        quizId: storedQuiz,
        name: storedName,
        playerId: storedPlayerId,
      });
    }

    function attemptReconnect() {
      lobbyStatus.textContent = 'Reconnecting to the game...';
      socket.emit('player:reconnect', { playerId: storedPlayerId, quizId: storedQuiz });
    }

    socket.on('connect', () => {
      attemptReconnect();
    });

    socket.on('reconnect', () => {
      attemptReconnect();
    });

    socket.on('player:joined', ({ quizId, title, totalQuestions, playerId }) => {
      currentQuizId = quizId;
      if (playerId) {
        storedPlayerId = playerId;
        localStorage.setItem('playerId', playerId);
        hasJoinedOnce = true;
      }
      if (quizId) {
        storedQuiz = quizId;
        localStorage.setItem('quizCode', quizId);
      }
      joinError.textContent = '';
      lobbyStatus.textContent = `Joined "${title}". Waiting for the first question...`;
      answerFeedback.textContent = '';
    });

    socket.on('player:reconnected', ({ quizId, title, playerId, name }) => {
      currentQuizId = quizId;
      joinError.textContent = '';
      lobbyStatus.textContent = `Reconnected to "${title}". Restoring your spot...`;
      storedPlayerId = playerId;
      storedName = name || storedName;
      storedQuiz = quizId;
      localStorage.setItem('playerId', storedPlayerId);
      if (storedName) localStorage.setItem('playerName', storedName);
      if (storedQuiz) localStorage.setItem('quizCode', storedQuiz);
      hasJoinedOnce = true;
    });

    socket.on('player:reconnectFailed', () => {
      if (storedName && storedQuiz) {
        joinQuiz('Rejoining game...');
      } else {
        window.location.href = '/join.html';
      }
    });

    socket.on('player:error', (message) => {
      joinError.textContent = message;
      lobbyStatus.textContent = 'Unable to join. Please re-enter the code and nickname.';
    });

    socket.on('question:start', ({ prompt, index, total, duration, media }) => {
      questionProgress.textContent = `Question ${index} of ${total}`;
      questionText.textContent = prompt;
      answerFeedback.textContent = '';
      answerFeedback.className = '';
      lobbyStatus.textContent = '';
      clearSubmission();
      answerForm.classList.remove('hidden');
      setAnswerWaiting(false);
      answerInput.value = '';
      answerInput.focus();
      renderMedia(media);
      startTimer(duration);
      hideOverlay();
      stopLobbyCountdown();
      toggleLeaderboard(false);
    });

    socket.on('question:end', ({ correctAnswer }) => {
      stopTimer();
      questionText.textContent = `Time's up! Correct answer: ${correctAnswer}`;
      if (lastSubmittedAnswer) {
        showSubmission({ correctAnswer });
      } else {
        clearSubmission();
      }
      answerForm.classList.add('hidden');
      setAnswerWaiting(false);
      questionMedia.innerHTML = '';
      timerEl.textContent = 'Time!';
      toggleLeaderboard(true);
    });

    socket.on('leaderboard:show', ({ leaderboard: board, duration }) => {
      renderOverlay(board, duration);
    });

    socket.on('quiz:finished', () => {
      stopTimer();
      questionProgress.textContent = 'Quiz finished';
      questionText.textContent = 'Quiz finished! Check the leaderboard for final scores.';
      answerForm.classList.add('hidden');
      setAnswerWaiting(false);
      questionMedia.innerHTML = '';
      timerEl.textContent = '--';
      toggleLeaderboard(true);
    });

    socket.on('quiz:ended', () => {
      stopTimer();
      questionProgress.textContent = 'Quiz closed';
      questionText.textContent = 'The host left the game. Quiz closed.';
      answerForm.classList.add('hidden');
      setAnswerWaiting(false);
      questionMedia.innerHTML = '';
      timerEl.textContent = '--';
      toggleLeaderboard(true);
    });

    socket.on('player:answerResult', ({ correct, earned, correctAnswer }) => {
      if (correct) {
        answerFeedback.textContent = `Correct! +${earned} points`;
        answerFeedback.className = 'success';
      } else {
        answerFeedback.textContent = `Not quite. Correct answer: ${correctAnswer}`;
        answerFeedback.className = 'error';
      }
      answerForm.classList.add('hidden');
      setAnswerWaiting(false);
      showSubmission({
        correctAnswer,
        status: correct ? 'correct' : 'incorrect',
      });
    });

    socket.on('leaderboard:update', (players) => {
      renderLeaderboard(players);
    });

    socket.on('player:state', ({ questionActive, question, timeRemaining, leaderboard: board, hasAnswered }) => {
      renderLeaderboard(board);

      if (questionActive && question) {
        questionProgress.textContent = `Question ${question.index} of ${question.total}`;
        questionText.textContent = question.prompt;
        renderMedia(question.media);
        hideOverlay();
        stopLobbyCountdown();
        lobbyStatus.textContent = '';
        setAnswerWaiting(hasAnswered);
        clearSubmission();
        if (hasAnswered) {
          answerForm.classList.add('hidden');
          answerFeedback.textContent = 'Answer received!';
          answerFeedback.className = 'success';
        } else {
          answerForm.classList.remove('hidden');
          answerInput.value = '';
          answerInput.focus();
          answerFeedback.textContent = '';
          answerFeedback.className = '';
        }
        const remaining = timeRemaining ?? question.duration;
        startTimer(remaining);
        toggleLeaderboard(false);
      } else {
        stopTimer();
        timerEl.textContent = '--';
        questionProgress.textContent = 'Waiting for host...';
        questionText.textContent = 'Waiting for the host to start...';
        answerForm.classList.add('hidden');
        setAnswerWaiting(false);
        answerFeedback.textContent = '';
        answerFeedback.className = '';
        questionMedia.innerHTML = '';
        toggleLeaderboard(true);
      }
    });

    socket.on('quiz:countdown', ({ seconds }) => {
      startLobbyCountdown(seconds);
    });

    answerForm.addEventListener('submit', (event) => {
      event.preventDefault();
      if (!currentQuizId) return;
      setAnswerWaiting(true);
      socket.emit('player:answer', {
        quizId: currentQuizId,
        answer: answerInput.value,
      });
      lastSubmittedAnswer = answerInput.value.trim();
      showSubmission({
        status: 'pending',
      });
    });

    function setAnswerWaiting(isWaiting) {
      answerInput.disabled = isWaiting;
      submitButton.disabled = isWaiting;
    }

    function startTimer(seconds) {
      stopTimer();
      let remaining = Math.round(seconds);
      if (!Number.isFinite(remaining) || remaining <= 0) {
        timerEl.textContent = 'Time!';
        return;
      }
      timerEl.textContent = `${remaining}s`;
      timerInterval = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          timerEl.textContent = 'Time!';
          stopTimer();
          return;
        }
        timerEl.textContent = `${remaining}s`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function renderLeaderboard(players) {
      leaderboard.innerHTML = '';
      if (!Array.isArray(players)) return;
      players.forEach((player, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        leaderboard.appendChild(li);
      });
    }

    function showSubmission({ status, correctAnswer }) {
      submissionCard.classList.remove('hidden');
      const hasAnswer = Boolean(lastSubmittedAnswer);
      submissionAnswer.textContent = hasAnswer
        ? `Your answer: ${lastSubmittedAnswer}`
        : 'No answer submitted this round.';

      if (status === 'pending') {
        submissionLabel.textContent = 'Submitted â€” waiting for result';
        submissionCorrect.classList.add('hidden');
      } else if (status === 'correct') {
        submissionLabel.textContent = 'Great job!';
        submissionCorrect.classList.remove('hidden');
      } else if (status === 'incorrect') {
        submissionLabel.textContent = 'Submitted';
        submissionCorrect.classList.remove('hidden');
      } else {
        submissionLabel.textContent = 'Round summary';
        submissionCorrect.classList.remove('hidden');
      }

      if (correctAnswer) {
        submissionCorrect.textContent = `Correct answer: ${correctAnswer}`;
      }
    }

    function clearSubmission() {
      submissionCard.classList.add('hidden');
      submissionLabel.textContent = 'Submission';
      submissionAnswer.textContent = '';
      submissionCorrect.textContent = '';
      submissionCorrect.classList.add('hidden');
      lastSubmittedAnswer = '';
    }

    function renderMedia(media) {
      questionMedia.innerHTML = '';
      if (!media) return;
      if (media.type === 'image') {
        questionMedia.innerHTML = `<img src="${media.src}" alt="Question media" />`;
      } else if (media.type === 'audio') {
        questionMedia.innerHTML = `<audio controls src="${media.src}"></audio>`;
      } else if (media.type === 'video') {
        questionMedia.innerHTML = `<video controls src="${media.src}"></video>`;
      }
    }

    function renderOverlay(players, duration) {
      overlayList.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('li');
        item.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        overlayList.appendChild(item);
      });
      overlayHint.textContent = duration ? `Next question in ${duration}s` : 'Quiz finished';
      overlay.classList.remove('hidden');
    }

    function hideOverlay() {
      overlay.classList.add('hidden');
      overlayList.innerHTML = '';
    }

    function toggleLeaderboard(show) {
      leaderboardCard.classList.toggle('hidden', !show);
    }

    function startLobbyCountdown(seconds) {
      stopLobbyCountdown();
      let remaining = seconds;
      lobbyStatus.textContent = `Game starting in ${remaining}s...`;
      lobbyCountdown = setInterval(() => {
        remaining -= 1;
        lobbyStatus.textContent = `Game starting in ${Math.max(remaining, 0)}s...`;
        if (remaining <= 0) {
          stopLobbyCountdown();
        }
      }, 1000);
    }

    function stopLobbyCountdown() {
      if (lobbyCountdown) {
        clearInterval(lobbyCountdown);
        lobbyCountdown = null;
      }
      lobbyStatus.textContent = '';
    }

  </script>
</body>
</html>
