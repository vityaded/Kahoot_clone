<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Live Game</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="player-view">
  <div class="glow"></div>
  <main class="player-container">
    <div class="player-status" id="lobby-status">Connecting to the game...</div>
    <p id="join-error" class="error"></p>

    <section class="question-board">
      <div class="corner-badge" id="question-progress">Waiting for host...</div>
      <div class="corner-badge timer" id="timer">--</div>
      <div class="question-content">
        <p class="eyebrow">Question</p>
        <h1 id="question-text">Waiting for the host to start...</h1>
        <div id="correct-answer-display" class="correct-answer" aria-live="polite"></div>
        <div id="player-answer-display" class="player-answer" aria-live="polite"></div>
        <div class="media-preview" id="question-media"></div>
      </div>
    </section>

    <section class="response-panel">
      <form id="answer-form" class="answer-card hidden" autocomplete="off">
        <label>
          Type your answer
          <input
            type="text"
            id="answer-input"
            name="response-field"
            autocomplete="new-password"
            autocapitalize="off"
            autocorrect="off"
            spellcheck="false"
          />
        </label>
        <button type="submit">Submit answer</button>
      </form>

      <div class="card leaderboard-card" id="leaderboard-card">
        <div class="leaderboard-header">
          <h2>Leaderboard</h2>
          <p class="muted">Live rankings</p>
        </div>
        <p id="answer-feedback"></p>
        <ul id="leaderboard"></ul>
      </div>
    </section>
  </main>

  <div id="leaderboard-overlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="leaderboard-header">
        <h2>Leaderboard</h2>
        <p id="overlay-hint" class="muted"></p>
      </div>
      <ul id="overlay-leaderboard"></ul>
    </div>
  </div>

  <div id="answer-indicator" class="answer-indicator hidden" aria-live="assertive" aria-atomic="true"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/player-shared.js"></script>
  <script>
    const socket = io();
    const playerView = new PlayerView({
      onSubmit: handleAnswerSubmit,
    });

    const { answerForm, answerInput } = playerView.el;

    const playerIdFromStorage = localStorage.getItem('playerId');
    let storedPlayerId = playerIdFromStorage;
    let storedQuiz = localStorage.getItem('quizCode');
    let storedName = localStorage.getItem('playerName');

    function generatePlayerId() {
      if (window.crypto?.randomUUID) return window.crypto.randomUUID();
      return Math.random().toString(36).slice(2, 12);
    }

    if (!storedPlayerId) {
      storedPlayerId = generatePlayerId();
      localStorage.setItem('playerId', storedPlayerId);
    }

    let currentQuizId = null;
    let hasJoinedOnce = Boolean(playerIdFromStorage);
    let lastSubmittedAnswer = '';
    let playerHasAnswered = false;

    function handleAnswerSubmit(trimmedAnswer) {
      if (!currentQuizId) {
        playerView.setAnswerWaiting(false);
        return;
      }
      socket.emit('player:answer', {
        quizId: currentQuizId,
        answer: trimmedAnswer,
      });
      lastSubmittedAnswer = trimmedAnswer;
      playerHasAnswered = true;
      playerView.setAnswerFeedback('');
    }

    function joinQuiz(message = 'Joining game...') {
      storedName = localStorage.getItem('playerName');
      storedQuiz = localStorage.getItem('quizCode');

      if (!storedName || !storedQuiz) {
        window.location.href = '/join.html';
        return;
      }

      playerView.setStatus(message);
      socket.emit('player:join', {
        quizId: storedQuiz,
        name: storedName,
        playerId: storedPlayerId,
      });
    }

    function attemptReconnect() {
      playerView.setStatus('Reconnecting to the game...');
      socket.emit('player:reconnect', { playerId: storedPlayerId, quizId: storedQuiz });
    }

    socket.on('connect', () => {
      attemptReconnect();
    });

    socket.on('reconnect', () => {
      attemptReconnect();
    });

    socket.on('player:joined', ({ quizId, title, totalQuestions, playerId }) => {
      currentQuizId = quizId;
      if (playerId) {
        storedPlayerId = playerId;
        localStorage.setItem('playerId', playerId);
        hasJoinedOnce = true;
      }
      if (quizId) {
        storedQuiz = quizId;
        localStorage.setItem('quizCode', quizId);
      }
      playerView.setError('');
      playerView.setStatus(`Joined "${title}". Waiting for the first question...`);
      playerView.setAnswerFeedback('');
    });

    socket.on('player:reconnected', ({ quizId, title, playerId, name }) => {
      currentQuizId = quizId;
      playerView.setError('');
      playerView.setStatus(`Reconnected to "${title}". Restoring your spot...`);
      storedPlayerId = playerId;
      storedName = name || storedName;
      storedQuiz = quizId;
      localStorage.setItem('playerId', storedPlayerId);
      if (storedName) localStorage.setItem('playerName', storedName);
      if (storedQuiz) localStorage.setItem('quizCode', storedQuiz);
      hasJoinedOnce = true;
    });

    socket.on('player:reconnectFailed', () => {
      if (storedName && storedQuiz) {
        joinQuiz('Rejoining game...');
      } else {
        window.location.href = '/join.html';
      }
    });

    socket.on('player:error', (message) => {
      playerView.setError(message);
      playerView.setStatus('Unable to join. Please re-enter the code and nickname.');
    });

    socket.on('question:start', ({ prompt, index, total, duration, media }) => {
      lastSubmittedAnswer = '';
      playerHasAnswered = false;
      playerView.startQuestion({ prompt, index, total, duration, media });
    });

    socket.on('question:end', ({ correctAnswer }) => {
      playerView.endQuestion({ correctAnswer, playerAnswer: lastSubmittedAnswer });
    });

    socket.on('leaderboard:show', ({ leaderboard: board, duration }) => {
      playerView.hideOverlay();
    });

    socket.on('quiz:finished', () => {
      playerView.stopTimer();
      playerView.setQuestionProgress('Quiz finished');
      playerView.setQuestionText('Quiz finished! Check the leaderboard for final scores.');
      answerForm.classList.add('hidden');
      playerView.setAnswerWaiting(false);
      playerView.resetInputEngagement();
      playerView.renderMedia(null);
      if (playerView.el.timer) playerView.el.timer.textContent = '--';
      playerView.toggleLeaderboard(false);
    });

    socket.on('quiz:ended', () => {
      playerView.stopTimer();
      playerView.setQuestionProgress('Quiz closed');
      playerView.setQuestionText('The host left the game. Quiz closed.');
      answerForm.classList.add('hidden');
      playerView.setAnswerWaiting(false);
      playerView.resetInputEngagement();
      playerView.renderMedia(null);
      if (playerView.el.timer) playerView.el.timer.textContent = '--';
      playerView.toggleLeaderboard(false);
    });

    socket.on('player:answerResult', ({ correct, partial, earned, correctAnswer, playerAnswer }) => {
      playerView.showAnswerResult({ correct, partial, earned, correctAnswer, playerAnswer });
      lastSubmittedAnswer = playerView.lastSubmittedAnswer;
      playerHasAnswered = true;
    });

    socket.on('leaderboard:update', (players) => {
      playerView.renderLeaderboard(players);
    });

    socket.on('player:state', ({ questionActive, question, timeRemaining, leaderboard: board, hasAnswered }) => {
      playerView.renderLeaderboard(board);

      if (questionActive && question) {
        playerView.setQuestionProgress(`Question ${question.index} of ${question.total}`);
        playerView.setQuestionText(question.prompt);
        playerView.renderMedia(question.media);
        playerView.hideOverlay();
        playerView.stopLobbyCountdown();
        playerView.setStatus('');
        playerView.setAnswerWaiting(hasAnswered);
        playerHasAnswered = hasAnswered;
        if (hasAnswered) {
          answerForm.classList.add('hidden');
          playerView.setAnswerFeedback('');
        } else {
          answerForm.classList.remove('hidden');
          playerView.resetInputEngagement();
          answerInput.value = '';
          playerView.setAnswerFeedback('');
        }
        const remaining = timeRemaining ?? question.duration;
        playerView.startTimer(remaining);
        playerView.toggleLeaderboard(false);
      } else {
        playerView.stopTimer();
        if (playerView.el.timer) playerView.el.timer.textContent = '--';
        playerView.setQuestionProgress('Waiting for host...');
        playerView.setQuestionText('Waiting for the host to start...');
        answerForm.classList.add('hidden');
        playerView.setAnswerWaiting(false);
        playerView.resetInputEngagement();
        playerView.setAnswerFeedback('');
        playerView.showCorrectAnswer('');
        playerView.showPlayerAnswer('');
        playerView.renderMedia(null);
        playerView.toggleLeaderboard(false);
      }
    });

    socket.on('quiz:countdown', ({ seconds }) => {
      playerView.startLobbyCountdown(seconds);
    });
  </script>
</body>
</html>
