<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Game</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="player-view">
  <div class="glow"></div>
  <main class="player-container">
    <div class="player-status" id="lobby-status">Connecting to the game...</div>
    <p id="join-error" class="error"></p>

    <section class="question-board">
      <div class="corner-badge" id="question-progress">Waiting for host...</div>
      <div class="corner-badge timer" id="timer">--</div>
      <div class="question-content">
        <p class="eyebrow">Question</p>
        <h1 id="question-text">Waiting for the host to start...</h1>
        <div class="media-preview" id="question-media"></div>
      </div>
    </section>

    <section class="response-panel">
      <form id="answer-form" class="answer-card hidden">
        <label>
          Type your answer
          <input type="text" id="answer-input" autocomplete="off" />
        </label>
        <button type="submit">Submit answer</button>
        <p class="muted">We'll lock it in right away, so double check before sending.</p>
      </form>

      <div class="card leaderboard-card">
        <div class="leaderboard-header">
          <h2>Leaderboard</h2>
          <p class="muted">Live rankings</p>
        </div>
        <p id="answer-feedback"></p>
        <ul id="leaderboard"></ul>
      </div>
    </section>
  </main>

  <div id="leaderboard-overlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="leaderboard-header">
        <h2>Leaderboard</h2>
        <p id="overlay-hint" class="muted"></p>
      </div>
      <ul id="overlay-leaderboard"></ul>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const lobbyStatus = document.getElementById('lobby-status');
    const joinError = document.getElementById('join-error');
    const questionText = document.getElementById('question-text');
    const timerEl = document.getElementById('timer');
    const answerForm = document.getElementById('answer-form');
    const answerInput = document.getElementById('answer-input');
    const answerFeedback = document.getElementById('answer-feedback');
    const leaderboard = document.getElementById('leaderboard');
    const questionMedia = document.getElementById('question-media');
    const questionProgress = document.getElementById('question-progress');
    const overlay = document.getElementById('leaderboard-overlay');
    const overlayList = document.getElementById('overlay-leaderboard');
    const overlayHint = document.getElementById('overlay-hint');

    function getPlayerId() {
      let id = localStorage.getItem('playerId');
      if (!id) {
        id = (crypto.randomUUID && crypto.randomUUID()) || `player-${Math.random().toString(16).slice(2)}`;
        localStorage.setItem('playerId', id);
      }
      return id;
    }

    const storedName = sessionStorage.getItem('playerName') || localStorage.getItem('lastPlayerName');
    const storedQuiz = sessionStorage.getItem('quizCode') || localStorage.getItem('lastQuizCode');
    const playerId = getPlayerId();
    if (!storedName || !storedQuiz) {
      window.location.href = '/join.html';
    } else {
      sessionStorage.setItem('playerName', storedName);
      sessionStorage.setItem('quizCode', storedQuiz);
    }

    let currentQuizId = null;
    let timerInterval = null;
    let lobbyCountdown = null;
    let hasJoined = false;

    function joinQuiz() {
      lobbyStatus.textContent = 'Joining game...';
      socket.emit('player:join', {
        quizId: storedQuiz,
        name: storedName,
        playerId,
      });
    }

    socket.on('player:joined', ({ quizId, title, totalQuestions }) => {
      currentQuizId = quizId;
      hasJoined = true;
      joinError.textContent = '';
      lobbyStatus.textContent = `Joined "${title}". Waiting for the first question...`;
      answerFeedback.textContent = '';
    });

    socket.on('player:error', (message) => {
      joinError.textContent = message;
      lobbyStatus.textContent = 'Unable to join. Please re-enter the code and nickname.';
    });

    function showQuestion({ prompt, index, total, duration, media, timeRemaining, hasAnswered }) {
      questionProgress.textContent = `Question ${index} of ${total}`;
      questionText.textContent = prompt;
      answerFeedback.textContent = hasAnswered ? 'Answer submitted. Waiting...' : '';
      answerFeedback.className = hasAnswered ? 'muted' : '';
      answerForm.classList.toggle('hidden', Boolean(hasAnswered));
      answerInput.value = '';
      if (!hasAnswered) {
        answerInput.focus();
      }
      renderMedia(media);
      startTimer(timeRemaining ?? duration);
      hideOverlay();
      stopLobbyCountdown();
    }

    socket.on('question:start', ({ prompt, index, total, duration, media }) => {
      showQuestion({ prompt, index, total, duration, media, timeRemaining: duration, hasAnswered: false });
    });

    socket.on('question:end', ({ correctAnswer }) => {
      stopTimer();
      questionText.textContent = `Time's up! Correct answer: ${correctAnswer}`;
      answerForm.classList.add('hidden');
      questionMedia.innerHTML = '';
      timerEl.textContent = '--';
    });

    socket.on('leaderboard:show', ({ leaderboard: board, duration }) => {
      renderOverlay(board, duration);
    });

    socket.on('quiz:finished', () => {
      stopTimer();
      questionProgress.textContent = 'Quiz finished';
      questionText.textContent = 'Quiz finished! Check the leaderboard for final scores.';
      answerForm.classList.add('hidden');
      questionMedia.innerHTML = '';
      timerEl.textContent = '--';
    });

    socket.on('quiz:ended', () => {
      stopTimer();
      questionProgress.textContent = 'Quiz closed';
      questionText.textContent = 'The host left the game. Quiz closed.';
      answerForm.classList.add('hidden');
      questionMedia.innerHTML = '';
      timerEl.textContent = '--';
    });

    socket.on('player:answerResult', ({ correct, earned, correctAnswer }) => {
      if (correct) {
        answerFeedback.textContent = `Correct! +${earned} points`;
        answerFeedback.className = 'success';
      } else {
        answerFeedback.textContent = `Not quite. Correct answer: ${correctAnswer}`;
        answerFeedback.className = 'error';
      }
      answerForm.classList.add('hidden');
      stopTimer();
      questionMedia.innerHTML = '';
    });

    function renderLeaderboard(players) {
      leaderboard.innerHTML = '';
      players.forEach((player, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        leaderboard.appendChild(li);
      });
    }

    socket.on('leaderboard:update', (players) => {
      renderLeaderboard(players);
    });

    socket.on('quiz:countdown', ({ seconds }) => {
      startLobbyCountdown(seconds);
    });

    socket.on('player:state', (state) => {
      currentQuizId = state.quizId;
      renderLeaderboard(state.leaderboard || []);

      if (state.lobbyCountdownSeconds) {
        startLobbyCountdown(state.lobbyCountdownSeconds);
      } else {
        stopLobbyCountdown();
      }

      if (state.question) {
        showQuestion(state.question);
        lobbyStatus.textContent = 'You are back in the game!';
      } else if (state.quizFinished) {
        stopTimer();
        questionProgress.textContent = 'Quiz finished';
        questionText.textContent = 'Quiz finished! Check the leaderboard for final scores.';
        answerForm.classList.add('hidden');
        questionMedia.innerHTML = '';
        timerEl.textContent = '--';
        lobbyStatus.textContent = 'Quiz finished';
      } else if (state.currentQuestionIndex === -1) {
        lobbyStatus.textContent = 'Waiting for the host to start...';
      } else {
        lobbyStatus.textContent = 'Waiting for the next question...';
      }

      if (state.overlay) {
        renderOverlay(state.overlay.leaderboard, state.overlay.duration);
      } else {
        hideOverlay();
      }
    });

    answerForm.addEventListener('submit', (event) => {
      event.preventDefault();
      if (!currentQuizId) return;
      socket.emit('player:answer', {
        quizId: currentQuizId,
        answer: answerInput.value,
      });
    });

    function startTimer(seconds) {
      stopTimer();
      const initial = Number.isFinite(seconds) ? seconds : 0;
      let remaining = Math.max(0, initial);
      timerEl.textContent = `${remaining}s`;
      timerInterval = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          timerEl.textContent = 'Time!';
          stopTimer();
          return;
        }
        timerEl.textContent = `${remaining}s`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function renderMedia(media) {
      questionMedia.innerHTML = '';
      if (!media) return;
      if (media.type === 'image') {
        questionMedia.innerHTML = `<img src="${media.src}" alt="Question media" />`;
      } else if (media.type === 'audio') {
        questionMedia.innerHTML = `<audio controls src="${media.src}"></audio>`;
      } else if (media.type === 'video') {
        questionMedia.innerHTML = `<video controls src="${media.src}"></video>`;
      }
    }

    function renderOverlay(players, duration) {
      overlayList.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('li');
        item.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        overlayList.appendChild(item);
      });
      overlayHint.textContent = duration ? `Next question in ${duration}s` : 'Quiz finished';
      overlay.classList.remove('hidden');
    }

    function hideOverlay() {
      overlay.classList.add('hidden');
      overlayList.innerHTML = '';
    }

    function startLobbyCountdown(seconds) {
      stopLobbyCountdown();
      let remaining = seconds;
      lobbyStatus.textContent = `Game starting in ${remaining}s...`;
      lobbyCountdown = setInterval(() => {
        remaining -= 1;
        lobbyStatus.textContent = `Game starting in ${Math.max(remaining, 0)}s...`;
        if (remaining <= 0) {
          stopLobbyCountdown();
        }
      }, 1000);
    }

    function stopLobbyCountdown() {
      if (lobbyCountdown) {
        clearInterval(lobbyCountdown);
        lobbyCountdown = null;
      }
    }

    socket.on('connect', () => {
      if (hasJoined) {
        socket.emit('player:requestState', { quizId: storedQuiz, playerId });
      } else {
        joinQuiz();
      }
    });

    if (socket.connected) {
      joinQuiz();
    }
  </script>
</body>
</html>
