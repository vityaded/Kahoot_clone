<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Create Quiz</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="host">
  <div class="glow"></div>
  <header>
    <h1>Design your quiz</h1>
    <p>Write prompts, upload supporting media, and generate a session code for running the game.</p>
    <div class="cta-row">
      <a class="button ghost" href="/">Back to library</a>
      <a class="button ghost" href="/run.html">Go to run page</a>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Quiz details</h2>
      <form id="quiz-form">
        <label>
          Quiz title
          <input type="text" id="quiz-title" placeholder="Science quick-check" />
        </label>
        <label>
          Seconds per question
          <input type="number" id="question-duration" value="20" min="5" max="120" />
        </label>
        <div class="questions" id="question-list"></div>
        <button type="button" class="ghost" id="add-question">+ Add question</button>
        <div class="bulk-card">
          <h3>Bulk add questions</h3>
          <p class="muted">Paste one question per line using pipes: <code>Question | Answer | Other acceptable answers</code>.</p>
          <textarea id="bulk-questions" rows="6" placeholder="What is the powerhouse of the cell? | Mitochondria | The mitochondrion"></textarea>
          <div class="cta-row">
            <button type="button" class="ghost" id="bulk-preview">Preview additions</button>
            <button type="button" id="bulk-add">Add to quiz</button>
          </div>
          <p id="bulk-error" class="error"></p>
          <div id="bulk-preview-list" class="preview-list"></div>
        </div>
        <button type="submit">Create quiz</button>
        <p id="form-error" class="error"></p>
      </form>
    </section>

    <section class="card" id="strictness-card">
      <h2>Answer grading strictness</h2>
      <p class="muted" id="strictness-summary">Loading strictness settings…</p>
      <div class="strictness-row">
        <div>
          <p class="eyebrow">Current mode</p>
          <div class="strictness-pill" id="strictness-pill">Normal</div>
        </div>
        <div class="muted" id="strictness-llm">LLM fallback: —</div>
      </div>
      <div class="strictness-details">
        <h3>Acceptance criteria for OK</h3>
        <ul id="strictness-ok" class="criteria-list"></ul>
        <h3>Partial credit behavior</h3>
        <ul id="strictness-partial" class="criteria-list"></ul>
      </div>
      <p class="muted" id="strictness-rules"></p>
    </section>

    <section class="card">
      <h2>Quiz code</h2>
      <div id="quiz-code" class="code">Waiting for quiz...</div>
      <p class="muted">After creating you'll get a fresh session code to share with players. Each run gets its own code.</p>
      <div id="host-credentials" class="credentials hidden">
        <p><strong>Session code:</strong> <span id="code-value"></span></p>
        <p><strong>Template code:</strong> <span id="template-value"></span></p>
        <p class="muted">Share the session code with players. Use the template code later to launch a brand-new session.</p>
        <div class="cta-row">
          <button id="copy-code" type="button" class="ghost">Copy session code</button>
          <button id="copy-template" type="button" class="ghost">Copy template code</button>
          <a id="run-link" class="button" href="/run.html">Open run page</a>
        </div>
      </div>
    </section>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const questionList = document.getElementById('question-list');
    const addQuestionBtn = document.getElementById('add-question');
    const form = document.getElementById('quiz-form');
    const quizCodeEl = document.getElementById('quiz-code');
    const formError = document.getElementById('form-error');
    const credentials = document.getElementById('host-credentials');
    const codeValue = document.getElementById('code-value');
    const templateValue = document.getElementById('template-value');
    const runLink = document.getElementById('run-link');
    const copyCodeBtn = document.getElementById('copy-code');
    const copyTemplateBtn = document.getElementById('copy-template');
    const strictnessSummary = document.getElementById('strictness-summary');
    const strictnessPill = document.getElementById('strictness-pill');
    const strictnessOk = document.getElementById('strictness-ok');
    const strictnessPartial = document.getElementById('strictness-partial');
    const strictnessLlm = document.getElementById('strictness-llm');
    const strictnessRules = document.getElementById('strictness-rules');

    const strictnessCopy = {
      strict: {
        title: 'Strict',
        summary: 'Exact normalized answers only. No synonyms, typo tolerance, or LLM fallback.',
        ok: [
          'Exact normalized match (case, punctuation, and diacritics ignored).',
          'Compact match (ignores spacing/hyphenation, e.g. "well-known" = "well known").',
        ],
        partial: [
          'Only explicit partial answers configured on the question.',
          'No synonym or typo-based partial credit.',
        ],
      },
      normal: {
        title: 'Normal',
        summary: 'Balanced matching with typo tolerance, synonyms, substrings, and LLM fallback.',
        ok: [
          'Exact normalized match plus compact match.',
          'Near-duplicate answers can still count as OK via close-match rules.',
        ],
        partial: [
          'Explicit partial answers.',
          'Synonyms and close matches may earn partial credit.',
        ],
      },
      lenient: {
        title: 'Lenient',
        summary: 'More forgiving matching with extra typo tolerance and LLM fallback.',
        ok: [
          'Exact normalized match plus compact match.',
          'More typo tolerance and close matches accepted.',
        ],
        partial: [
          'Explicit partial answers.',
          'Synonyms and close matches more likely to earn partial credit.',
        ],
      },
    };

    function renderStrictnessDetails(payload) {
      const strictness = payload?.strictness || 'normal';
      const copy = strictnessCopy[strictness] || strictnessCopy.normal;
      strictnessSummary.textContent = copy.summary;
      strictnessPill.textContent = copy.title;

      strictnessOk.innerHTML = '';
      copy.ok.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        strictnessOk.appendChild(li);
      });

      strictnessPartial.innerHTML = '';
      copy.partial.forEach((item) => {
        const li = document.createElement('li');
        li.textContent = item;
        strictnessPartial.appendChild(li);
      });

      const ruleConfig = payload?.ruleConfig || {};
      const llmDefaults = payload?.llmDefaults || {};
      const closeMatch = ruleConfig.allowCloseMatch
        ? `Close-match threshold: ${(ruleConfig.closeMatchThreshold ?? 0.8).toFixed(2)}`
        : 'Close-match disabled';
      const synonyms = ruleConfig.allowSynonyms ? 'Synonyms enabled' : 'Synonyms disabled';
      const substrings = ruleConfig.allowSubstrings ? 'Substring checks enabled' : 'Substring checks disabled';
      const compact = ruleConfig.allowCompactMatch ? 'Compact match enabled' : 'Compact match disabled';
      strictnessRules.textContent = `Rules: ${compact} · ${closeMatch} · ${synonyms} · ${substrings}`;

      if (ruleConfig.allowLLMFallback) {
        strictnessLlm.textContent = `LLM fallback: enabled (${llmDefaults.mode} mode, confidence ≥ ${(llmDefaults.confidenceThreshold ?? 0.8).toFixed(2)})`;
      } else {
        strictnessLlm.textContent = 'LLM fallback: disabled (strict mode)';
      }
    }

    function renderQuestionRow(index, prompt = '', answer = '', alternateAnswers = [], partialAnswers = []) {
      const wrapper = document.createElement('div');
      wrapper.className = 'question-row media';
      wrapper.innerHTML = `
        <div>
          <label>Question ${index + 1}
            <input type="text" name="prompt" placeholder="What is photosynthesis?" value="${prompt}" required />
          </label>
          <label>Expected answer
            <input type="text" name="answer" placeholder="A process plants use to make food" value="${answer}" required />
          </label>
          <label>Alternate answers (separate with ||)
            <input type="text" name="alternate" placeholder="Other phrasing that should count as correct (use || between options)" value="${alternateAnswers.join(' || ')}" />
          </label>
          <label>Partial credit answers (synonyms or near-misses, use ||)
            <input type="text" name="partial" placeholder="Counts for half points (use || between options)" value="${partialAnswers.join(' || ')}" />
          </label>
        </div>
        <div class="media-picker">
          <label class="file-label">Attach media (photo, audio, or video)
            <input type="file" accept="image/*,audio/*,video/*" name="media" />
          </label>
          <div class="preview" aria-live="polite"></div>
        </div>
        <button type="button" class="ghost remove">Remove</button>
      `;
      wrapper.querySelector('.remove').addEventListener('click', () => {
        wrapper.remove();
        updateQuestionLabels();
      });
      wrapper.querySelector('input[name="media"]').addEventListener('change', (event) => {
        const preview = wrapper.querySelector('.preview');
        preview.innerHTML = '';
        const file = event.target.files?.[0];
        if (!file) return;
        const type = file.type;
        if (type.startsWith('image/')) {
          preview.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Image preview" />`;
        } else if (type.startsWith('audio/')) {
          preview.innerHTML = `<audio controls src="${URL.createObjectURL(file)}"></audio>`;
        } else if (type.startsWith('video/')) {
          preview.innerHTML = `<video controls src="${URL.createObjectURL(file)}"></video>`;
        } else {
          preview.textContent = file.name;
        }
      });
      questionList.appendChild(wrapper);
    }

    function updateQuestionLabels() {
      questionList.querySelectorAll('.question-row').forEach((row, idx) => {
        row.querySelector('label').innerHTML = `Question ${idx + 1}<input type="text" name="prompt" placeholder="What is photosynthesis?" value="${row.querySelector('input[name="prompt"]').value}" required />`;
      });
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    }

    async function buildQuestions() {
      const rows = Array.from(questionList.querySelectorAll('.question-row'));
      const questions = [];
      for (const row of rows) {
        const prompt = row.querySelector('input[name="prompt"]').value;
        const answer = row.querySelector('input[name="answer"]').value;
        const alternateRaw = row.querySelector('input[name="alternate"]').value;
        const partialRaw = row.querySelector('input[name="partial"]').value;
        const alternateAnswers = alternateRaw
          .split(/\|\|/)
          .map((part) => part.trim())
          .filter(Boolean);
        const partialAnswers = partialRaw
          .split(/\|\|/)
          .map((part) => part.trim())
          .filter(Boolean);
        const mediaInput = row.querySelector('input[name="media"]');
        const file = mediaInput?.files?.[0];
        let media = null;
        if (file) {
          const src = await readFileAsDataURL(file);
          let type = 'file';
          if (file.type.startsWith('image/')) type = 'image';
          else if (file.type.startsWith('audio/')) type = 'audio';
          else if (file.type.startsWith('video/')) type = 'video';
          media = { type, name: file.name, src };
        }
        questions.push({ prompt, answer, alternateAnswers, partialAnswers, media });
      }
      return questions;
    }

    function parseBulkQuestions(raw) {
      const lines = raw
        .split(/\n|\r/)
        .map((line) => line.trim())
        .filter(Boolean);

      const parsed = lines.map((line) => {
        const parts = line.split(/\|/).map((part) => part.trim()).filter(Boolean);
        const [prompt, answer, ...alternates] = parts;
        return { prompt, answer, alternateAnswers: alternates };
      });

      return parsed.filter((q) => q.prompt && q.answer);
    }

    function renderBulkPreview(questions) {
      const preview = document.getElementById('bulk-preview-list');
      preview.innerHTML = '';
      questions.forEach((q, idx) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        const alternates = q.alternateAnswers.length ? ` | Variants: ${q.alternateAnswers.join(' || ')}` : '';
        item.textContent = `${idx + 1}. ${q.prompt} → ${q.answer}${alternates}`;
        preview.appendChild(item);
      });
    }

    function appendBulkQuestions(questions) {
      questions.forEach((q) => {
        renderQuestionRow(
          questionList.children.length,
          q.prompt,
          q.answer,
          q.alternateAnswers,
          q.partialAnswers,
        );
      });
      updateQuestionLabels();
    }

    const bulkInput = document.getElementById('bulk-questions');
    const bulkPreviewBtn = document.getElementById('bulk-preview');
    const bulkAddBtn = document.getElementById('bulk-add');
    const bulkError = document.getElementById('bulk-error');

    bulkPreviewBtn.addEventListener('click', () => {
      bulkError.textContent = '';
      const parsed = parseBulkQuestions(bulkInput.value);
      if (!parsed.length) {
        bulkError.textContent = 'Enter at least one line with a question and answer separated by |';
        return;
      }
      renderBulkPreview(parsed);
    });

    bulkAddBtn.addEventListener('click', () => {
      bulkError.textContent = '';
      const parsed = parseBulkQuestions(bulkInput.value);
      if (!parsed.length) {
        bulkError.textContent = 'Enter at least one line with a question and answer separated by |';
        return;
      }
      appendBulkQuestions(parsed);
      renderBulkPreview([]);
      bulkInput.value = '';
    });

    addQuestionBtn.addEventListener('click', () => renderQuestionRow(questionList.children.length));

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      formError.textContent = '';
      quizCodeEl.textContent = 'Creating quiz...';
      const questions = await buildQuestions();
      const title = document.getElementById('quiz-title').value;
      const questionDuration = document.getElementById('question-duration').value;

      socket.emit('host:createQuiz', { title, questions, questionDuration });
    });

    socket.on('host:error', (message) => {
      formError.textContent = message;
      quizCodeEl.textContent = 'Waiting for quiz...';
    });

    socket.on('host:quizCreated', ({ quizId, templateId }) => {
      quizCodeEl.textContent = `Share this session code: ${quizId}`;
      credentials.classList.remove('hidden');
      codeValue.textContent = quizId;
      templateValue.textContent = templateId;
      runLink.href = `/run.html?quizId=${quizId}`;
      sessionStorage.setItem('quizId', quizId);
      sessionStorage.setItem('templateId', templateId);
    });

    copyCodeBtn.addEventListener('click', () => {
      if (!codeValue.textContent) return;
      navigator.clipboard.writeText(codeValue.textContent);
      copyCodeBtn.textContent = 'Copied!';
      setTimeout(() => { copyCodeBtn.textContent = 'Copy code'; }, 1200);
    });

    copyTemplateBtn.addEventListener('click', () => {
      if (!templateValue.textContent) return;
      navigator.clipboard.writeText(templateValue.textContent);
      copyTemplateBtn.textContent = 'Copied!';
      setTimeout(() => { copyTemplateBtn.textContent = 'Copy template code'; }, 1200);
    });

    fetch('/api/settings/answer-strictness')
      .then((response) => response.json())
      .then((payload) => renderStrictnessDetails(payload))
      .catch(() => {
        strictnessSummary.textContent = 'Unable to load strictness settings right now.';
      });

    renderQuestionRow(0);
  </script>
</body>
</html>
