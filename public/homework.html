<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Homework quiz</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="player-view">
  <div class="glow"></div>
  <main class="player-container">
    <div class="player-status" id="lobby-status">Loading assignment...</div>
    <p id="join-error" class="error"></p>

    <section class="question-board">
      <div class="corner-badge" id="question-progress">Preparing question...</div>
      <div class="corner-badge timer" id="timer">--</div>
      <div class="question-content">
        <p class="eyebrow">Homework</p>
        <h1 id="question-text">Fetching assignment details...</h1>
        <div id="correct-answer-display" class="correct-answer" aria-live="polite"></div>
        <div id="player-answer-display" class="player-answer" aria-live="polite"></div>
        <div class="media-preview" id="question-media"></div>
      </div>
    </section>

    <section class="response-panel">
      <form id="answer-form" class="answer-card hidden" autocomplete="off">
        <label>
          Your name
          <input type="text" id="player-name" name="player-name" autocomplete="off" autocapitalize="words" />
        </label>
        <label>
          Type your answer
          <input
            type="text"
            id="answer-input"
            name="response-field"
            autocomplete="new-password"
            autocapitalize="off"
            autocorrect="off"
            spellcheck="false"
          />
        </label>
        <button type="submit">Submit answer</button>
      </form>

      <div class="card leaderboard-card" id="leaderboard-card">
        <div class="leaderboard-header">
          <h2 id="assignment-title">Homework assignment</h2>
          <p id="assignment-meta" class="muted">Loading assignment details...</p>
          <p class="muted mobile-only">Leaderboard hidden on mobile for more space.</p>
        </div>
        <p id="answer-feedback"></p>
        <ul id="leaderboard" class="leaderboard-list"></ul>
        <div id="homework-result" class="stacked hidden">
          <p class="eyebrow">Submission received</p>
          <p id="result-score"></p>
          <p id="result-detail" class="muted"></p>
          <a class="button ghost" href="/join.html">Join a live quiz</a>
        </div>
      </div>
    </section>
  </main>

  <div id="leaderboard-overlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="leaderboard-header">
        <h2>Leaderboard</h2>
        <p id="overlay-hint" class="muted"></p>
      </div>
      <ul id="overlay-leaderboard" class="leaderboard-list"></ul>
    </div>
  </div>

  <div id="answer-indicator" class="answer-indicator hidden" aria-live="assertive" aria-atomic="true"></div>

  <script src="/js/player-shared.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const assignmentId = params.get('assignmentId')?.trim();

    const assignmentTitle = document.getElementById('assignment-title');
    const assignmentMeta = document.getElementById('assignment-meta');
    const formError = document.getElementById('join-error');
    const nameInput = document.getElementById('player-name');
    const resultBlock = document.getElementById('homework-result');
    const resultScore = document.getElementById('result-score');
    const resultDetail = document.getElementById('result-detail');

    const playerView = new PlayerView({
      onSubmit: handleAnswer,
      onTimeExpired: handleTimeExpired,
    });

    const { answerForm } = playerView.el;

    let assignmentQuestions = [];
    let answers = [];
    let currentIndex = 0;

    function setError(text) {
      formError.textContent = text;
    }

    function handleAnswer(trimmedAnswer) {
      setError('');
      const playerName = nameInput.value.trim();
      if (!playerName) {
        setError('Please enter your name to continue.');
        playerView.setAnswerWaiting(false);
        return;
      }

      answers[currentIndex] = trimmedAnswer;
      proceedToNextQuestion();
    }

    function handleTimeExpired() {
      if (answers[currentIndex]) return;
      answers[currentIndex] = '';
      proceedToNextQuestion();
    }

    function proceedToNextQuestion() {
      playerView.stopTimer();
      playerView.showPlayerAnswer('');
      playerView.showCorrectAnswer('');
      playerView.setAnswerWaiting(false);
      answerForm.classList.add('hidden');
      currentIndex += 1;
      if (currentIndex >= assignmentQuestions.length) {
        submitAnswers();
      } else {
        startQuestion(currentIndex);
      }
    }

    function startQuestion(index) {
      const question = assignmentQuestions[index];
      if (!question) return;
      playerView.setStatus('');
      playerView.hideOverlay();
      const duration = calculateQuestionDuration(question.prompt);
      playerView.startQuestion({
        prompt: question.prompt,
        index: index + 1,
        total: assignmentQuestions.length,
        duration,
        media: question.media,
      });
      answerForm.classList.remove('hidden');
      nameInput.disabled = false;
    }

    async function loadAssignment() {
      if (!assignmentId) {
        assignmentMeta.textContent = 'Missing assignment ID. Use the link provided by your teacher.';
        setError('Missing assignment ID.');
        return;
      }

      try {
        const response = await fetch(`/api/assignments/${assignmentId}/take`);
        if (!response.ok) throw new Error('Not found');
        const assignment = await response.json();
        assignmentTitle.textContent = assignment.assignmentTitle;
        assignmentMeta.textContent = `${assignment.quizTitle} Â· ${assignment.questions.length} question${assignment.questions.length === 1 ? '' : 's'}`;

        assignmentQuestions = assignment.questions || [];
        answers = new Array(assignmentQuestions.length).fill('');
        currentIndex = 0;

        if (!assignmentQuestions.length) {
          playerView.setQuestionText('This assignment has no questions.');
          playerView.setQuestionProgress('No questions');
          answerForm.classList.add('hidden');
          return;
        }

        startQuestion(0);
      } catch (error) {
        assignmentMeta.textContent = 'This assignment could not be loaded.';
        playerView.setQuestionText('Assignment unavailable');
        playerView.setStatus('');
        setError('This assignment could not be loaded.');
      }
    }

    async function submitAnswers() {
      const playerName = nameInput.value.trim();
      if (!playerName) {
        setError('Please enter your name to submit.');
        currentIndex = Math.max(currentIndex - 1, 0);
        startQuestion(currentIndex);
        return;
      }

      playerView.setStatus('Submitting your responses...');
      playerView.setAnswerWaiting(true);
      answerForm.classList.add('hidden');

      const payload = assignmentQuestions.map((_, idx) => answers[idx] || '');

      try {
        const response = await fetch(`/api/assignments/${assignmentId}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: playerName, answers: payload }),
        });
        if (!response.ok) throw new Error('Submit failed');
        const result = await response.json();
        playerView.stopTimer();
        playerView.setQuestionProgress('Submission complete');
        playerView.setQuestionText('Thanks for completing the homework!');
        playerView.renderMedia(null);
        if (playerView.el.timer) playerView.el.timer.textContent = '--';
        playerView.setStatus('');
        playerView.showCorrectAnswer('');
        playerView.showPlayerAnswer('');
        playerView.setAnswerFeedback('');
        nameInput.disabled = true;
        resultBlock.classList.remove('hidden');
        resultScore.textContent = `You scored ${result.submission.score} points.`;
        resultDetail.textContent = `You were ${result.submission.percent}% correct across ${result.submission.totalQuestions} question${result.submission.totalQuestions === 1 ? '' : 's'}.`;
      } catch (error) {
        setError('Unable to submit right now. Please try again.');
        playerView.setAnswerWaiting(false);
        answerForm.classList.remove('hidden');
        currentIndex = Math.max(currentIndex - 1, 0);
        startQuestion(currentIndex);
      }
    }

    loadAssignment();
  </script>
</body>
</html>
