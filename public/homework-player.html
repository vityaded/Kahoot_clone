<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Homework Quiz</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="player-view">
  <div class="glow"></div>
  <main class="player-container">
    <section class="card">
      <p class="eyebrow">Homework code</p>
      <h1 id="homework-title">Loading homework...</h1>
      <p id="homework-meta" class="muted"></p>
      <p id="homework-error" class="error"></p>
    </section>

    <section class="card" id="intro-card">
      <h2>Ready to begin?</h2>
      <p class="muted">Enter your name to start answering questions at your own pace.</p>
      <label>
        Your name
        <input type="text" id="player-name" placeholder="Alex" />
      </label>
      <button type="button" id="start-homework">Start homework</button>
    </section>

    <section class="card hidden" id="question-card">
      <div class="card-heading">
        <p class="eyebrow" id="question-progress"></p>
        <p class="muted" id="question-duration"></p>
      </div>
      <h2 id="question-text">Loading question...</h2>
      <div class="media-preview" id="question-media"></div>
      <label>
        Your answer
        <input type="text" id="answer-input" autocomplete="off" autocapitalize="off" autocorrect="off" />
      </label>
      <div class="cta-row">
        <button type="button" id="next-question">Next</button>
      </div>
    </section>

    <section class="card hidden" id="completion-card">
      <div class="card-heading">
        <div>
          <p class="eyebrow">Homework complete</p>
          <h2>Thanks for submitting!</h2>
        </div>
        <div class="quiz-actions">
          <span id="score-display" class="muted"></span>
        </div>
      </div>
      <p class="muted">Review the questions you missed below. Correct answers are shown for anything marked incorrect.</p>
      <div id="review-list" class="review-list"></div>
      <button type="button" id="retake-homework" class="ghost">Try again</button>
    </section>
  </main>

  <div id="leaderboard-overlay" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="overlay-card">
      <div class="leaderboard-header">
        <h3 id="leaderboard-title">Homework leaderboard</h3>
        <button type="button" id="leaderboard-continue">Continue</button>
      </div>
      <p class="muted" id="leaderboard-status">Here’s how everyone is doing so far.</p>
      <ul id="leaderboard-list"></ul>
    </div>
  </div>

  <div id="answer-indicator" class="answer-indicator hidden" aria-live="polite">✓</div>
  <div id="feedback-toast" class="feedback-toast hidden" role="status" aria-live="polite">
    <div class="feedback-content">
      <p class="feedback-status" id="feedback-status"></p>
      <p class="feedback-prompt" id="feedback-prompt"></p>
      <p class="feedback-line">
        <span>Correct answer:</span>
        <span id="feedback-correct"></span>
      </p>
      <p class="feedback-line">
        <span>Your answer:</span>
        <span id="feedback-player"></span>
      </p>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const homeworkId = params.get('homeworkId');

    const homeworkTitle = document.getElementById('homework-title');
    const homeworkMeta = document.getElementById('homework-meta');
    const homeworkError = document.getElementById('homework-error');
    const introCard = document.getElementById('intro-card');
    const questionCard = document.getElementById('question-card');
    const completionCard = document.getElementById('completion-card');
    const playerNameInput = document.getElementById('player-name');
    const startButton = document.getElementById('start-homework');
    const questionText = document.getElementById('question-text');
    const questionProgress = document.getElementById('question-progress');
    const questionDuration = document.getElementById('question-duration');
    const questionMedia = document.getElementById('question-media');
    const answerInput = document.getElementById('answer-input');
    const nextQuestionButton = document.getElementById('next-question');
    const reviewList = document.getElementById('review-list');
    const scoreDisplay = document.getElementById('score-display');
    const retakeButton = document.getElementById('retake-homework');
    const answerIndicator = document.getElementById('answer-indicator');
    const feedbackToast = document.getElementById('feedback-toast');
    const feedbackStatus = document.getElementById('feedback-status');
    const feedbackPrompt = document.getElementById('feedback-prompt');
    const feedbackCorrect = document.getElementById('feedback-correct');
    const feedbackPlayer = document.getElementById('feedback-player');
    const leaderboardOverlay = document.getElementById('leaderboard-overlay');
    const leaderboardList = document.getElementById('leaderboard-list');
    const leaderboardStatus = document.getElementById('leaderboard-status');
    const leaderboardContinue = document.getElementById('leaderboard-continue');
    const leaderboardTitle = document.getElementById('leaderboard-title');

    let questions = [];
    let answers = [];
    let currentIndex = 0;
    let homeworkCode = '';
    let timerId = null;
    let timeRemaining = 0;
    let advancing = false;
    let feedbackTimer = null;
    let leaderboardTimer = null;

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function startTimer(durationSeconds) {
      stopTimer();
      const parsedDuration = Number(durationSeconds);
      if (!Number.isFinite(parsedDuration) || parsedDuration <= 0) {
        questionDuration.textContent = '';
        return;
      }

      timeRemaining = Math.max(1, Math.round(parsedDuration));
      questionDuration.textContent = `${timeRemaining}s left`;

      timerId = setInterval(() => {
        timeRemaining -= 1;
        if (timeRemaining <= 0) {
          questionDuration.textContent = 'Time is up';
          stopTimer();
          handleAnswerAdvance();
          return;
        }
        questionDuration.textContent = `${timeRemaining}s left`;
      }, 1000);
    }

    function getActiveMedia(container) {
      return container?.querySelector('video, audio') || null;
    }

    function removeTapOverlay(container) {
      container?.querySelector('.tap-to-play-overlay')?.remove();
    }

    function ensureMediaContainer(container) {
      if (!container) return;
      const currentPosition = window.getComputedStyle(container).position;
      if (currentPosition === 'static') {
        container.style.position = 'relative';
      }
    }

    function stopMedia(container) {
      const mediaEl = getActiveMedia(container);
      if (mediaEl) {
        mediaEl.pause();
        mediaEl.currentTime = 0;
      }
      removeTapOverlay(container);
    }

    function showTapToPlayOverlay(container, mediaEl, label = 'Tap to play') {
      if (!container || !mediaEl) return;
      ensureMediaContainer(container);
      removeTapOverlay(container);

      const overlay = document.createElement('button');
      overlay.type = 'button';
      overlay.textContent = label;
      overlay.className = 'tap-to-play-overlay';
      overlay.style.position = 'absolute';
      overlay.style.inset = '0';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.background = 'rgba(0, 0, 0, 0.35)';
      overlay.style.color = '#fff';
      overlay.style.border = 'none';
      overlay.style.fontWeight = '600';
      overlay.style.cursor = 'pointer';
      overlay.style.backdropFilter = 'blur(1px)';

      const removeOverlay = () => removeTapOverlay(container);
      overlay.addEventListener('click', () => {
        mediaEl.muted = false;
        const resumePromise = mediaEl.play();
        if (resumePromise?.then) {
          resumePromise.then(removeOverlay).catch(() => {});
        } else {
          removeOverlay();
        }
      });
      mediaEl.addEventListener('playing', removeOverlay, { once: true });

      container.appendChild(overlay);
    }

    function attemptAutoplay(mediaEl, container) {
      if (!mediaEl) return;
      mediaEl.currentTime = 0;
      if (mediaEl.tagName === 'VIDEO') {
        mediaEl.playsInline = true;
      }
      const removeOverlay = () => removeTapOverlay(container);
      const playPromise = mediaEl.play();
      if (!playPromise?.catch) {
        return;
      }
      playPromise.then(removeOverlay).catch(() => {
        mediaEl.muted = true;
        const mutedAttempt = mediaEl.play();
        if (mutedAttempt?.catch) {
          mutedAttempt.then(() => {
            showTapToPlayOverlay(container, mediaEl, 'Tap to unmute');
          }).catch(() => {
            showTapToPlayOverlay(container, mediaEl);
          });
        } else {
          showTapToPlayOverlay(container, mediaEl, 'Tap to unmute');
        }
      });
    }

    function renderMedia(media) {
      stopMedia(questionMedia);
      questionMedia.innerHTML = '';
      if (!media?.src || !media?.type) return;
      if (media.type === 'image') {
        const img = document.createElement('img');
        img.src = media.src;
        img.alt = media.name || 'Question image';
        questionMedia.appendChild(img);
        return;
      }
      if (media.type === 'audio') {
        const audio = document.createElement('audio');
        audio.src = media.src;
        audio.controls = true;
        audio.autoplay = true;
        audio.preload = 'auto';
        questionMedia.appendChild(audio);
        return;
      }
      if (media.type === 'video') {
        const video = document.createElement('video');
        video.src = media.src;
        video.controls = true;
        video.autoplay = true;
        video.preload = 'auto';
        video.playsInline = true;
        questionMedia.appendChild(video);
      }
    }

    function showCard(card) {
      [introCard, questionCard, completionCard].forEach((panel) => {
        panel.classList.toggle('hidden', panel !== card);
      });
    }

    function renderQuestion(index) {
      const question = questions[index];
      if (!question) return;
      questionText.textContent = question.prompt;
      questionProgress.textContent = `Question ${index + 1} of ${questions.length}`;
      stopTimer();
      questionDuration.textContent = '';
      renderMedia(question.media);
      const mediaEl = getActiveMedia(questionMedia);
      if (mediaEl) {
        attemptAutoplay(mediaEl, questionMedia);
      }
      answerInput.value = answers[index] || '';
      answerInput.focus();
      nextQuestionButton.textContent = index === questions.length - 1 ? 'Submit homework' : 'Next';
      startTimer(question.duration);
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'No due date';
      const date = new Date(timestamp);
      return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }

    async function loadHomework() {
      if (!homeworkId) {
        homeworkError.textContent = 'Homework code missing.';
        return;
      }
      try {
        const response = await fetch(`/api/homework/${homeworkId}`);
        if (!response.ok) throw new Error('not-found');
        const data = await response.json();
        homeworkCode = data.id;
        homeworkTitle.textContent = data.title;
        homeworkMeta.textContent = `${data.questionCount} question${data.questionCount === 1 ? '' : 's'} · Code ${data.id} · Due ${formatDate(data.dueAt)}`;
        questions = data.questions || [];
        answers = new Array(questions.length).fill('');
      } catch (error) {
        homeworkError.textContent = 'Unable to load this homework assignment. Check the code and try again.';
        introCard.classList.add('hidden');
      }
    }

    function renderReview(items) {
      reviewList.innerHTML = '';
      if (!items.length) {
        const success = document.createElement('p');
        success.className = 'muted';
        success.textContent = 'Nice work! You answered every question correctly.';
        reviewList.appendChild(success);
        return;
      }

      items.forEach((item) => {
        const block = document.createElement('div');
        block.className = 'review-item';
        block.innerHTML = `
          <p class="eyebrow">${item.prompt}</p>
          <p><strong>Your answer:</strong> ${item.submitted || '<em>No answer</em>'}</p>
          <p><strong>Correct answer:</strong> ${item.correctAnswer || '<em>Not provided</em>'}</p>
        `;
        reviewList.appendChild(block);
      });
    }

    function renderLeaderboard(entries) {
      leaderboardList.innerHTML = '';

      if (!entries?.length) {
        const empty = document.createElement('li');
        empty.className = 'muted';
        empty.textContent = 'No submissions yet.';
        leaderboardList.appendChild(empty);
        return;
      }

      entries.forEach((entry, index) => {
        const item = document.createElement('li');
        const position = document.createElement('span');
        position.textContent = `${index + 1}. ${entry.name || 'Player'}`;
        const score = document.createElement('span');
        score.textContent = `${entry.score ?? 0} pts`;
        item.appendChild(position);
        item.appendChild(score);
        leaderboardList.appendChild(item);
      });
    }

    function closeLeaderboardOverlay(resolve) {
      leaderboardOverlay.classList.add('hidden');
      leaderboardContinue.disabled = false;
      if (leaderboardTimer) {
        clearTimeout(leaderboardTimer);
        leaderboardTimer = null;
      }
      resolve();
    }

    function showLeaderboardOverlay(entries, title) {
      return new Promise((resolve) => {
        leaderboardTitle.textContent = title || 'Homework leaderboard';
        leaderboardStatus.textContent = 'Here’s how everyone is doing so far.';
        renderLeaderboard(entries);
        leaderboardOverlay.classList.remove('hidden');
        leaderboardContinue.disabled = false;

        const handleDismiss = () => {
          leaderboardContinue.removeEventListener('click', handleDismiss);
          closeLeaderboardOverlay(resolve);
        };

        leaderboardContinue.addEventListener('click', handleDismiss, { once: true });
        leaderboardTimer = setTimeout(() => {
          leaderboardContinue.removeEventListener('click', handleDismiss);
          closeLeaderboardOverlay(resolve);
        }, 3500);
      });
    }

    async function fetchLeaderboard() {
      if (!homeworkCode) return [];
      try {
        const response = await fetch(`/api/homework/${homeworkCode}/leaderboard`);
        if (!response.ok) throw new Error('leaderboard-load-failed');
        const data = await response.json();
        return Array.isArray(data) ? data : [];
      } catch (error) {
        return [];
      }
    }

    async function resolveLeaderboard(payload) {
      if (Array.isArray(payload?.leaderboard)) return payload.leaderboard;
      return fetchLeaderboard();
    }

    function hideFeedbackElements() {
      answerIndicator.classList.add('hidden');
      answerIndicator.classList.remove('visible');
      feedbackToast.classList.add('hidden');
      feedbackToast.classList.remove('visible');
    }

    function restoreFocus() {
      if (!questionCard.classList.contains('hidden')) {
        answerInput.focus();
      }
    }

    function populateFeedback(evaluation, question) {
      const isPartial = evaluation?.isPartial;
      feedbackStatus.textContent = isPartial ? 'Almost there' : 'Not quite right';
      feedbackPrompt.textContent = question?.prompt || 'Question';
      feedbackCorrect.textContent = evaluation?.correctAnswer || 'No correct answer provided';
      feedbackPlayer.textContent = evaluation?.playerAnswer || 'No answer provided';
    }

    function showCheckmark() {
      return new Promise((resolve) => {
        answerIndicator.textContent = '✓';
        answerIndicator.classList.remove('hidden', 'partial', 'incorrect');
        answerIndicator.classList.add('visible', 'correct');

        feedbackTimer = setTimeout(() => {
          answerIndicator.classList.remove('visible');
          feedbackTimer = setTimeout(() => {
            answerIndicator.classList.add('hidden');
            restoreFocus();
            resolve();
          }, 180);
        }, 500);
      });
    }

    function showFeedbackToast(evaluation, question) {
      return new Promise((resolve) => {
        populateFeedback(evaluation, question);
        feedbackToast.classList.remove('hidden');
        feedbackToast.classList.add('visible');

        feedbackTimer = setTimeout(() => {
          feedbackToast.classList.remove('visible');
          feedbackTimer = setTimeout(() => {
            feedbackToast.classList.add('hidden');
            restoreFocus();
            resolve();
          }, 180);
        }, 2000);
      });
    }

    async function showEvaluationFeedback(evaluation, question) {
      if (!evaluation) return;
      stopTimer();
      clearTimeout(feedbackTimer);
      hideFeedbackElements();
      if (evaluation.isCorrect) {
        await showCheckmark();
        return;
      }
      await showFeedbackToast(evaluation, question);
    }

    async function evaluateCurrentAnswer() {
      if (!homeworkCode) return null;
      try {
        const response = await fetch(`/api/homework/${homeworkCode}/evaluate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            answer: answerInput.value,
            questionIndex: currentIndex,
          }),
        });
        if (!response.ok) throw new Error('evaluation-failed');
        return await response.json();
      } catch (error) {
        return null;
      }
    }

    async function handleAnswerAdvance() {
      if (advancing) return;
      advancing = true;
      stopTimer();

      const question = questions[currentIndex];
      if (!question) {
        advancing = false;
        return;
      }

      answers[currentIndex] = answerInput.value;
      const evaluation = await evaluateCurrentAnswer();
      await showEvaluationFeedback(evaluation, question);

      advanceQuestion();
      advancing = false;
    }

    function advanceQuestion() {
      if (currentIndex === questions.length - 1) {
        stopTimer();
        submitHomework();
        return;
      }
      currentIndex += 1;
      renderQuestion(currentIndex);
    }

    async function submitHomework() {
      const name = playerNameInput.value.trim();
      if (!name) {
        homeworkError.textContent = 'Please enter your name before submitting.';
        return;
      }
      homeworkError.textContent = '';
      stopTimer();
      stopMedia(questionMedia);
      try {
        const response = await fetch(`/api/homework/${homeworkCode}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ playerName: name, answers }),
        });
        if (!response.ok) throw new Error('submit-failed');
        const data = await response.json();
        localStorage.setItem('playerName', name);
        scoreDisplay.textContent = `${data?.submission?.score ?? 0} pts`;
        const leaderboard = await resolveLeaderboard(data);
        await showLeaderboardOverlay(leaderboard, `${data?.title || homeworkTitle.textContent} leaderboard`);
        renderReview(data?.review || []);
        showCard(completionCard);
      } catch (error) {
        homeworkError.textContent = 'Unable to submit your homework right now. Please try again.';
      }
    }

    nextQuestionButton.addEventListener('click', handleAnswerAdvance);

    startButton.addEventListener('click', () => {
      const name = playerNameInput.value.trim();
      if (!name) {
        homeworkError.textContent = 'Please enter your name to begin.';
        return;
      }
      if (!questions.length) {
        homeworkError.textContent = 'This homework does not have any questions yet.';
        return;
      }
      homeworkError.textContent = '';
      showCard(questionCard);
      renderQuestion(currentIndex);
    });

    retakeButton.addEventListener('click', () => {
      stopTimer();
      stopMedia(questionMedia);
      clearTimeout(feedbackTimer);
      hideFeedbackElements();
      answers = new Array(questions.length).fill('');
      currentIndex = 0;
      answerInput.value = '';
      showCard(questionCard);
      renderQuestion(currentIndex);
    });

    window.addEventListener('load', () => {
      const storedName = localStorage.getItem('playerName');
      if (storedName) {
        playerNameInput.value = storedName;
      }
      loadHomework();
    });
  </script>
</body>
</html>
