<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Join Homework</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="glow"></div>
  <header>
    <h1>Join a homework assignment</h1>
    <p>Enter the assignment code and your nickname to start the self-paced quiz.</p>
    <div class="cta-row">
      <a class="button ghost" href="/">Back to library</a>
      <button type="button" id="copy-join-link" class="ghost">Copy assignments link</button>
    </div>
  </header>

  <main class="grid single">
    <section class="card">
      <form id="join-form">
        <label>
          Assignment code
          <input type="text" id="assignment-code" placeholder="123456" inputmode="numeric" pattern="\d{6}" maxlength="6" required />
        </label>
        <label>
          Nickname
          <input type="text" id="player-name" placeholder="Your name" required />
        </label>
        <button type="submit">Start homework</button>
        <p id="join-error" class="error"></p>
        <p id="link-hint" class="muted"></p>
      </form>
    </section>
  </main>

  <script>
    const joinForm = document.getElementById('join-form');
    const assignmentInput = document.getElementById('assignment-code');
    const nameInput = document.getElementById('player-name');
    const joinError = document.getElementById('join-error');
    const linkHint = document.getElementById('link-hint');
    const copyJoinLinkBtn = document.getElementById('copy-join-link');

    function sanitizeCode(raw) {
      const digitsOnly = raw?.trim().replace(/\D/g, '');
      return digitsOnly && digitsOnly.length === 6 ? digitsOnly : '';
    }

    function buildShareLink(code = '') {
      const url = new URL('/homework-join.html', window.location.href);
      if (code) {
        url.searchParams.set('assignmentId', code);
        url.searchParams.set('autoJoin', '1');
      }
      return url.toString();
    }

    joinForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const code = sanitizeCode(assignmentInput.value);
      const name = nameInput.value?.trim();
      if (!code) {
        joinError.textContent = 'Enter the 6-digit assignment code you received.';
        return;
      }
      if (!name) {
        joinError.textContent = 'Please enter a nickname.';
        return;
      }

      localStorage.setItem('homeworkCode', code);
      localStorage.setItem('homeworkName', name);
      window.location.href = '/homework-play.html';
    });

    const params = new URLSearchParams(window.location.search);
    const paramCode = sanitizeCode(params.get('assignmentId'));
    const autoJoin = params.get('autoJoin') === '1';

    if (copyJoinLinkBtn) {
      copyJoinLinkBtn.addEventListener('click', () => {
        const code = sanitizeCode(assignmentInput.value) || sanitizeCode(localStorage.getItem('homeworkCode'));
        navigator.clipboard.writeText(buildShareLink(code));
        copyJoinLinkBtn.textContent = 'Link copied!';
        setTimeout(() => { copyJoinLinkBtn.textContent = 'Copy assignments link'; }, 1200);
      });
    }

    if (paramCode) {
      assignmentInput.value = paramCode;
      assignmentInput.readOnly = true;
      assignmentInput.setAttribute('aria-readonly', 'true');
      localStorage.setItem('homeworkCode', paramCode);
      linkHint.textContent = 'This link already contains the assignment code. Add your nickname and start.';

      if (autoJoin) {
        const storedName = localStorage.getItem('homeworkName');
        if (storedName) {
          window.location.href = '/homework-play.html';
        }
      }
    } else {
      linkHint.textContent = 'Share an assignment link so learners never need to track a host.';
    }
  </script>
</body>
</html>
