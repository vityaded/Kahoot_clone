<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run Quiz</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="host">
  <div class="glow"></div>
  <header>
    <h1>Run the game</h1>
    <p>Enter a quiz code to control questions, watch the leaderboard, and prompt players. Every time you launch a quiz, a unique code is created.</p>
    <div class="cta-row">
      <a class="button ghost" href="/">Back to library</a>
      <a class="button ghost" href="/create.html">Create another quiz</a>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Claim host control</h2>
      <form id="claim-form">
        <label>
          Quiz code
          <input type="text" id="quiz-code" placeholder="ABC123" required />
        </label>
        <button type="submit">Connect as host</button>
        <p id="claim-error" class="error"></p>
      </form>
      <p id="quiz-meta" class="muted"></p>
      <div id="session-code" class="code muted"></div>
    </section>

    <section class="card">
      <h2>Player lobby</h2>
      <div class="leaderboard">
        <div class="leaderboard-header">
          <span>Leaderboard</span>
          <span id="player-count">0 players</span>
        </div>
        <ul id="leaderboard-list"></ul>
      </div>
    </section>

    <section class="card">
      <h2>Control room</h2>
      <div id="question-status" class="question-status">No question running.</div>
      <div id="media-preview" class="media-preview"></div>
      <button type="button" id="start-question" disabled>Start next question</button>
      <button type="button" id="end-question" class="ghost" disabled>End current question</button>
    </section>
  </main>

  <audio id="loop-audio" loop>
    <source src="https://upload.wikimedia.org/wikipedia/commons/transcoded/0/07/Acoustic_Loop_-_EMF.wav/Acoustic_Loop_-_EMF.wav.mp3" type="audio/mpeg" />
  </audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const claimForm = document.getElementById('claim-form');
    const quizCodeInput = document.getElementById('quiz-code');
    const claimError = document.getElementById('claim-error');
    const quizMeta = document.getElementById('quiz-meta');
    const playerCount = document.getElementById('player-count');
    const leaderboardList = document.getElementById('leaderboard-list');
    const startQuestionBtn = document.getElementById('start-question');
    const endQuestionBtn = document.getElementById('end-question');
    const questionStatus = document.getElementById('question-status');
    const mediaPreview = document.getElementById('media-preview');
    const loopAudio = document.getElementById('loop-audio');
    const sessionCode = document.getElementById('session-code');

    let quizId = null;
    let timerId = null;

    function saveHostCredentials(id) {
      sessionStorage.setItem('quizId', id);
    }

    function loadHostCredentials() {
      const params = new URLSearchParams(window.location.search);
      const storedQuizId = sessionStorage.getItem('quizId');
      quizCodeInput.value = params.get('quizId') || storedQuizId || '';
    }

    function renderLeaderboard(players) {
      leaderboardList.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('li');
        item.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        leaderboardList.appendChild(item);
      });
      playerCount.textContent = `${players.length} player${players.length === 1 ? '' : 's'}`;
    }

    function showMedia(media) {
      mediaPreview.innerHTML = '';
      if (!media) return;
      if (media.type === 'image') {
        mediaPreview.innerHTML = `<img src="${media.src}" alt="Question media" />`;
      } else if (media.type === 'audio') {
        mediaPreview.innerHTML = `<audio controls src="${media.src}"></audio>`;
      } else if (media.type === 'video') {
        mediaPreview.innerHTML = `<video controls src="${media.src}"></video>`;
      }
    }

    claimForm.addEventListener('submit', (event) => {
      event.preventDefault();
      claimError.textContent = '';
      socket.emit('host:claimHost', { quizId: quizCodeInput.value });
    });

    socket.on('host:claimed', ({ quizId: id, title, totalQuestions, questionDuration, leaderboard }) => {
      quizId = id;
      saveHostCredentials(id);
      quizMeta.textContent = `${title} · ${totalQuestions} question(s) · ${questionDuration}s each`;
      sessionCode.textContent = `Player session code: ${id}`;
      quizCodeInput.value = id;
      startQuestionBtn.disabled = false;
      endQuestionBtn.disabled = true;
      renderLeaderboard(leaderboard);
      loopAudio.volume = 0.3;
      loopAudio.play().catch(() => {});
    });

    socket.on('host:error', (message) => {
      claimError.textContent = message;
      sessionCode.textContent = '';
    });

    socket.on('host:playerJoined', (players) => {
      renderLeaderboard(players);
    });

    socket.on('leaderboard:update', (players) => {
      renderLeaderboard(players);
    });

    startQuestionBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:startQuestion', { quizId });
    });

    endQuestionBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:endQuestion', { quizId });
    });

    socket.on('question:start', ({ prompt, index, total, duration, media }) => {
      questionStatus.textContent = `Question ${index}/${total}: ${prompt}`;
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = false;
      questionStatus.classList.add('active');
      setTimeout(() => questionStatus.classList.remove('active'), 500);
      showMedia(media);
      countdown(duration);
    });

    socket.on('question:end', ({ correctAnswer }) => {
      questionStatus.textContent = `Question ended. Correct answer: ${correctAnswer}`;
      startQuestionBtn.disabled = false;
      endQuestionBtn.disabled = true;
      questionStatus.classList.remove('active');
      stopTimer();
      mediaPreview.innerHTML = '';
    });

    socket.on('quiz:finished', () => {
      questionStatus.textContent = 'Quiz complete! Share the leaderboard.';
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      stopTimer();
      loopAudio.pause();
    });

    socket.on('quiz:ended', () => {
      questionStatus.textContent = 'Quiz ended. Host disconnected or closed the game.';
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      stopTimer();
      mediaPreview.innerHTML = '';
    });

    function countdown(seconds) {
      stopTimer();
      let remaining = seconds;
      timerId = setInterval(() => {
        if (remaining <= 0) {
          stopTimer();
          questionStatus.textContent = 'Time\'s up!';
          startQuestionBtn.disabled = false;
          endQuestionBtn.disabled = true;
          mediaPreview.innerHTML = '';
          return;
        }
        questionStatus.textContent = `${remaining}s left...`;
        remaining -= 1;
      }, 1000);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    loadHostCredentials();
  </script>
</body>
</html>
