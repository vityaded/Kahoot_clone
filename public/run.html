<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Run Quiz</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="host">
  <div class="glow"></div>
  <header>
    <h1>Run the game</h1>
    <p>Enter a quiz code to control questions, watch the leaderboard, and prompt players. Every time you launch a quiz, a unique code is created.</p>
    <div class="cta-row">
      <a class="button ghost" href="/">Back to library</a>
      <a class="button ghost" href="/create.html">Create another quiz</a>
      <a class="button ghost" href="/homework.html">Assignments</a>
    </div>
  </header>

  <div class="host-layout">
    <section class="card host-stage" aria-live="polite">
      <div class="stage-meta">
        <span id="stage-progress" class="eyebrow">Waiting to start</span>
        <div class="stage-meta-trailing">
          <span id="stage-timer" class="stage-timer">--</span>
          <span class="stage-chip" id="stage-chip">Preview mode</span>
        </div>
      </div>
      <div class="stage-content">
        <p class="eyebrow">Question display</p>
        <h1 id="stage-prompt">Launch a question to project it here.</h1>
        <div id="stage-media" class="stage-media"></div>
      </div>
    </section>

    <aside class="host-panels">
      <section class="card">
        <h2>Claim host control</h2>
        <form id="claim-form">
          <label>
            Quiz code
            <input type="text" id="quiz-code" placeholder="Enter quiz code" required />
          </label>
          <button type="submit">Connect as host</button>
          <p id="claim-error" class="error"></p>
        </form>
      </section>

      <section class="card">
        <h2>Player lobby</h2>
        <div class="leaderboard">
          <div class="leaderboard-header">
            <span>Leaderboard</span>
            <span id="player-count">0 players</span>
          </div>
          <ul id="leaderboard-list"></ul>
        </div>
      </section>

      <section class="card control-card">
        <h2>Control room</h2>
        <div id="question-status" class="question-status">No question running.</div>
        <div id="media-preview" class="media-preview"></div>
        <button type="button" id="start-question" disabled>Start next question</button>
        <button type="button" id="end-question" class="ghost" disabled>End current question</button>
      </section>
    </aside>
  </div>

  <footer class="host-footer">
    <button type="button" id="footer-toggle" class="footer-toggle" aria-label="Minimize footer details"></button>
    <div id="qr-section" class="qr-section">
      <p class="eyebrow">QR code</p>
      <div class="footer-qr">
        <button type="button" class="qr-wrapper" id="qr-trigger">
          <img id="qr-image" src="" alt="QR code to join the quiz" />
          <span class="qr-hint">Tap to enlarge</span>
        </button>
        <p class="qr-link" id="qr-link">Waiting for a quiz code...</p>
      </div>
    </div>
    <div class="footer-code">
      <p class="eyebrow">Quiz code</p>
      <div id="session-code" class="code muted">Awaiting quiz code...</div>
      <p id="quiz-meta" class="muted">No session connected yet.</p>
    </div>
    <div class="footer-duration">
      <p class="eyebrow">Time setup</p>
      <div class="inline-input stacked">
        <input type="number" id="duration-input" min="5" max="300" />
        <button type="button" id="update-duration" class="ghost">Update</button>
      </div>
      <div id="countdown-banner" class="muted"></div>
    </div>
  </footer>

  <div id="leaderboard-overlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="leaderboard-header">
        <h2>Leaderboard</h2>
        <p id="overlay-hint" class="muted"></p>
      </div>
      <ul id="overlay-leaderboard"></ul>
    </div>
  </div>

  <div id="qr-overlay" class="overlay hidden">
    <div class="overlay-card qr-card">
      <div class="leaderboard-header">
        <h2>Scan to join</h2>
        <p class="muted">This opens the nickname page with the code prefilled.</p>
      </div>
      <img id="qr-large" src="" alt="Large QR code" />
      <p class="qr-overlay-link" id="qr-overlay-link"></p>
    </div>
  </div>

  <audio id="loop-audio" loop>
    <source src="https://upload.wikimedia.org/wikipedia/commons/transcoded/0/07/Acoustic_Loop_-_EMF.wav/Acoustic_Loop_-_EMF.wav.mp3" type="audio/mpeg" />
  </audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const hostBody = document.body;
    const claimForm = document.getElementById('claim-form');
    const quizCodeInput = document.getElementById('quiz-code');
    const claimError = document.getElementById('claim-error');
    const quizMeta = document.getElementById('quiz-meta');
    const playerCount = document.getElementById('player-count');
    const leaderboardList = document.getElementById('leaderboard-list');
    const startQuestionBtn = document.getElementById('start-question');
    const endQuestionBtn = document.getElementById('end-question');
    const questionStatus = document.getElementById('question-status');
    const mediaPreview = document.getElementById('media-preview');
    const stagePrompt = document.getElementById('stage-prompt');
    const stageMedia = document.getElementById('stage-media');
    const stageProgress = document.getElementById('stage-progress');
    const stageTimer = document.getElementById('stage-timer');
    const stageChip = document.getElementById('stage-chip');
    const loopAudio = document.getElementById('loop-audio');
    const sessionCode = document.getElementById('session-code');
    const durationInput = document.getElementById('duration-input');
    const updateDurationBtn = document.getElementById('update-duration');
    const overlay = document.getElementById('leaderboard-overlay');
    const overlayList = document.getElementById('overlay-leaderboard');
    const overlayHint = document.getElementById('overlay-hint');
    const countdownBanner = document.getElementById('countdown-banner');
    const qrSection = document.getElementById('qr-section');
    const qrImage = document.getElementById('qr-image');
    const qrLink = document.getElementById('qr-link');
    const qrOverlay = document.getElementById('qr-overlay');
    const qrLarge = document.getElementById('qr-large');
    const qrOverlayLink = document.getElementById('qr-overlay-link');
    const qrTrigger = document.getElementById('qr-trigger');
    const footer = document.querySelector('.host-footer');
    const footerToggle = document.getElementById('footer-toggle');

    let quizId = null;
    let timerId = null;
    let countdownId = null;
    let quizTitle = '';
    let totalQuestions = 0;

    function normalizeHostCode(raw) {
      const trimmed = raw?.trim();
      return trimmed ? trimmed.toUpperCase() : '';
    }

    function setFooterCollapsed(collapsed) {
      if (!footer) return;
      footer.classList.toggle('footer-collapsed', collapsed);
      if (footerToggle) {
        footerToggle.classList.toggle('is-collapsed', collapsed);
        footerToggle.setAttribute('aria-pressed', collapsed ? 'true' : 'false');
        footerToggle.setAttribute('aria-label', collapsed ? 'Expand footer details' : 'Minimize footer details');
      }
    }

    function buildJoinUrl(code) {
      const url = new URL(window.location.origin + '/join.html');
      url.searchParams.set('quizId', code);
      url.searchParams.set('autoJoin', '1');
      url.searchParams.set('via', 'qr');
      return url.toString();
    }

    function updateQr(quizCode) {
      const joinUrl = buildJoinUrl(quizCode);
      const smallQr = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(joinUrl)}`;
      const largeQr = `https://api.qrserver.com/v1/create-qr-code/?size=360x360&data=${encodeURIComponent(joinUrl)}`;

      qrImage.src = smallQr;
      qrImage.alt = `QR code for quiz ${quizCode}`;
      qrImage.dataset.large = largeQr;
      qrLink.textContent = joinUrl;
      qrOverlayLink.textContent = joinUrl;
      qrLarge.src = largeQr;
    }

    function saveHostCredentials(id) {
      sessionStorage.setItem('quizId', id);
    }

    function loadHostCredentials() {
      const params = new URLSearchParams(window.location.search);
      const storedQuizId = normalizeHostCode(sessionStorage.getItem('quizId'));
      const paramCode = normalizeHostCode(params.get('quizId'));
      quizCodeInput.value = paramCode || storedQuizId || '';
    }

    footerToggle?.addEventListener('click', () => {
      const nextCollapsed = !footer.classList.contains('footer-collapsed');
      setFooterCollapsed(nextCollapsed);
    });

    setFooterCollapsed(false);

    function renderLeaderboard(players) {
      leaderboardList.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('li');
        item.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        leaderboardList.appendChild(item);
      });
      playerCount.textContent = `${players.length} player${players.length === 1 ? '' : 's'}`;
    }

    function renderMedia(container, media) {
      container.innerHTML = '';
      if (!media) return;
      if (media.type === 'image') {
        container.innerHTML = `<img src="${media.src}" alt="Question media" />`;
      } else if (media.type === 'audio') {
        container.innerHTML = `<audio controls src="${media.src}"></audio>`;
      } else if (media.type === 'video') {
        container.innerHTML = `<video controls src="${media.src}"></video>`;
      }
    }

    function showMedia(media) {
      renderMedia(mediaPreview, media);
      renderMedia(stageMedia, media);
    }

    claimForm.addEventListener('submit', (event) => {
      event.preventDefault();
      claimError.textContent = '';
      const normalized = normalizeHostCode(quizCodeInput.value);
      if (!normalized) {
        claimError.textContent = 'Enter a quiz code to connect as host.';
        return;
      }
      socket.emit('host:claimHost', { quizId: normalized });
    });

    socket.on('host:claimed', ({ quizId: id, title, totalQuestions: total, questionDuration, leaderboard }) => {
      quizId = id;
      quizTitle = title;
      totalQuestions = total;
      saveHostCredentials(id);
      updateMeta(questionDuration);
      sessionCode.textContent = `Player session code: ${id}`;
      quizCodeInput.value = id;
      startQuestionBtn.disabled = false;
      endQuestionBtn.disabled = true;
      durationInput.value = questionDuration;
      renderLeaderboard(leaderboard);
      loopAudio.volume = 0.3;
      loopAudio.play().catch(() => {});
      updateQr(id);
      stagePrompt.textContent = `Ready to run "${title}"`;
      stageProgress.textContent = 'Waiting to start';
      stageTimer.textContent = `${questionDuration}s`;
      stageChip.textContent = 'Waiting to start';
      hostBody.classList.remove('question-live');
    });

    socket.on('host:error', (message) => {
      claimError.textContent = message;
      sessionCode.textContent = 'Awaiting quiz code...';
      quizMeta.textContent = '';
    });

    socket.on('host:playerJoined', (players) => {
      renderLeaderboard(players);
    });

    socket.on('leaderboard:update', (players) => {
      renderLeaderboard(players);
    });

    socket.on('quiz:durationChanged', ({ duration }) => {
      durationInput.value = duration;
      updateMeta(duration);
    });

    startQuestionBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:startQuestion', { quizId });
    });

    endQuestionBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:endQuestion', { quizId });
    });

    updateDurationBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:updateDuration', { quizId, duration: durationInput.value });
    });

    socket.on('host:durationUpdated', ({ duration }) => {
      durationInput.value = duration;
      countdownBanner.textContent = `Updated: ${duration}s per question for upcoming rounds.`;
      updateMeta(duration);
      setTimeout(() => { countdownBanner.textContent = ''; }, 3000);
    });

    socket.on('question:start', ({ prompt, index, total, duration, media }) => {
      questionStatus.textContent = `Question ${index}/${total}: ${prompt}`;
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = false;
      questionStatus.classList.add('active');
      setTimeout(() => questionStatus.classList.remove('active'), 500);
      stagePrompt.textContent = prompt;
      stageProgress.textContent = `Question ${index}/${total}`;
      stageTimer.textContent = `${duration}s`;
      stageChip.textContent = 'Question live';
      showMedia(media);
      countdown(duration);
      hideOverlay();
      stopCountdownBanner();
      hostBody.classList.add('question-live');
      document.querySelector('.host-stage').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    socket.on('question:end', ({ correctAnswer }) => {
      questionStatus.textContent = `Question ended. Correct answer: ${correctAnswer}`;
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      questionStatus.classList.remove('active');
      stopTimer();
      mediaPreview.innerHTML = '';
      stageMedia.innerHTML = '';
      stageTimer.textContent = '--';
      stageProgress.textContent = 'Waiting for next question';
      stagePrompt.textContent = correctAnswer ? `Answer: ${correctAnswer}` : 'Waiting for next question';
      stageChip.textContent = 'Preview mode';
      hostBody.classList.remove('question-live');
    });

    socket.on('leaderboard:show', ({ leaderboard, duration }) => {
      startQuestionBtn.disabled = true;
      renderOverlay(leaderboard, duration);
    });

    socket.on('quiz:finished', () => {
      questionStatus.textContent = 'Quiz complete! Share the leaderboard.';
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      stopTimer();
      loopAudio.pause();
      stagePrompt.textContent = 'Quiz complete!';
      stageProgress.textContent = 'Finished';
      stageTimer.textContent = '--';
      stageChip.textContent = 'Finished';
      hostBody.classList.remove('question-live');
    });

    socket.on('quiz:ended', () => {
      questionStatus.textContent = 'Quiz ended. Host disconnected or closed the game.';
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      stopTimer();
      mediaPreview.innerHTML = '';
      stageMedia.innerHTML = '';
      stagePrompt.textContent = 'Quiz ended. Reclaim control to restart.';
      stageProgress.textContent = 'Disconnected';
      stageTimer.textContent = '--';
      stageChip.textContent = 'Disconnected';
      hostBody.classList.remove('question-live');
    });

    socket.on('quiz:countdown', ({ seconds }) => {
      startLobbyCountdown(seconds);
    });

    function countdown(seconds) {
      stopTimer();
      let remaining = seconds;
      stageTimer.textContent = `${remaining}s`;
      timerId = setInterval(() => {
        if (remaining <= 0) {
          stopTimer();
          questionStatus.textContent = 'Time\'s up!';
          startQuestionBtn.disabled = true;
          endQuestionBtn.disabled = true;
          mediaPreview.innerHTML = '';
          stageMedia.innerHTML = '';
          stageTimer.textContent = '0s';
          return;
        }
        questionStatus.textContent = `Time left: ${remaining}s`;
        stageTimer.textContent = `${remaining}s`;
        remaining -= 1;
      }, 1000);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      stageTimer.textContent = '--';
    }

    function updateMeta(duration) {
      quizMeta.textContent = `${quizTitle} · ${totalQuestions} question(s) · ${duration}s each`;
    }

    function renderOverlay(players, duration) {
      overlayList.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('li');
        item.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        overlayList.appendChild(item);
      });
      overlay.classList.remove('hidden');
      overlayHint.textContent = duration ? `Next question in ${duration}s` : 'Quiz finished';
    }

    function hideOverlay() {
      overlay.classList.add('hidden');
      overlayList.innerHTML = '';
    }

    function startLobbyCountdown(seconds) {
      stopCountdownBanner();
      let remaining = seconds;
      countdownBanner.textContent = `Quiz starts automatically in ${remaining}s`;
      countdownId = setInterval(() => {
        remaining -= 1;
        countdownBanner.textContent = `Quiz starts automatically in ${Math.max(remaining, 0)}s`;
        if (remaining <= 0) stopCountdownBanner();
      }, 1000);
    }

    function stopCountdownBanner() {
      if (countdownId) {
        clearInterval(countdownId);
        countdownId = null;
      }
      countdownBanner.textContent = '';
    }

    qrTrigger.addEventListener('click', () => {
      if (!qrImage.dataset.large) return;
      qrOverlay.classList.remove('hidden');
    });

    qrOverlay.addEventListener('click', () => {
      qrOverlay.classList.add('hidden');
    });

    loadHostCredentials();
    const initialCode = normalizeHostCode(quizCodeInput.value);
    if (initialCode) {
      socket.emit('host:claimHost', { quizId: initialCode });
    }
  </script>
</body>
</html>
