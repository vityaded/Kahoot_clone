<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run Quiz</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="host">
  <div class="glow"></div>
  <header>
    <h1>Run the game</h1>
    <p>Enter a quiz code to control questions, watch the leaderboard, and prompt players. Every time you launch a quiz, a unique code is created.</p>
    <div class="cta-row">
      <a class="button ghost" href="/">Back to library</a>
      <a class="button ghost" href="/create.html">Create another quiz</a>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Claim host control</h2>
      <form id="claim-form">
        <label>
          Quiz code
          <input type="text" id="quiz-code" placeholder="ABC123" required />
        </label>
        <button type="submit">Connect as host</button>
        <p id="claim-error" class="error"></p>
      </form>
      <p id="quiz-meta" class="muted"></p>
      <div id="session-code" class="code muted"></div>

      <div id="qr-section" class="qr-section hidden">
        <p class="muted">Share this QR so players can jump straight to the nickname screen.</p>
        <button type="button" class="qr-wrapper" id="qr-trigger">
          <img id="qr-image" src="" alt="QR code to join the quiz" />
          <span class="qr-hint">Tap to enlarge</span>
        </button>
        <p class="qr-link" id="qr-link"></p>
      </div>
    </section>

    <section class="card">
      <h2>Player lobby</h2>
      <div class="leaderboard">
        <div class="leaderboard-header">
          <span>Leaderboard</span>
          <span id="player-count">0 players</span>
        </div>
        <ul id="leaderboard-list"></ul>
      </div>
    </section>

    <section class="card">
      <h2>Control room</h2>
      <div id="question-status" class="question-status">No question running.</div>
      <div id="media-preview" class="media-preview"></div>
      <div class="control-row">
        <label>
          Seconds per question
          <div class="inline-input">
            <input type="number" id="duration-input" min="5" max="300" />
            <button type="button" id="update-duration" class="ghost">Update</button>
          </div>
        </label>
        <div id="countdown-banner" class="muted"></div>
      </div>
      <button type="button" id="start-question" disabled>Start next question</button>
      <button type="button" id="end-question" class="ghost" disabled>End current question</button>
    </section>
  </main>

  <div id="leaderboard-overlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="leaderboard-header">
        <h2>Leaderboard</h2>
        <p id="overlay-hint" class="muted"></p>
      </div>
      <ul id="overlay-leaderboard"></ul>
    </div>
  </div>

  <div id="qr-overlay" class="overlay hidden">
    <div class="overlay-card qr-card">
      <div class="leaderboard-header">
        <h2>Scan to join</h2>
        <p class="muted">This opens the nickname page with the code prefilled.</p>
      </div>
      <img id="qr-large" src="" alt="Large QR code" />
      <p class="qr-overlay-link" id="qr-overlay-link"></p>
    </div>
  </div>

  <audio id="loop-audio" loop>
    <source src="https://upload.wikimedia.org/wikipedia/commons/transcoded/0/07/Acoustic_Loop_-_EMF.wav/Acoustic_Loop_-_EMF.wav.mp3" type="audio/mpeg" />
  </audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const claimForm = document.getElementById('claim-form');
    const quizCodeInput = document.getElementById('quiz-code');
    const claimError = document.getElementById('claim-error');
    const quizMeta = document.getElementById('quiz-meta');
    const playerCount = document.getElementById('player-count');
    const leaderboardList = document.getElementById('leaderboard-list');
    const startQuestionBtn = document.getElementById('start-question');
    const endQuestionBtn = document.getElementById('end-question');
    const questionStatus = document.getElementById('question-status');
    const mediaPreview = document.getElementById('media-preview');
    const loopAudio = document.getElementById('loop-audio');
    const sessionCode = document.getElementById('session-code');
    const durationInput = document.getElementById('duration-input');
    const updateDurationBtn = document.getElementById('update-duration');
    const overlay = document.getElementById('leaderboard-overlay');
    const overlayList = document.getElementById('overlay-leaderboard');
    const overlayHint = document.getElementById('overlay-hint');
    const countdownBanner = document.getElementById('countdown-banner');
    const qrSection = document.getElementById('qr-section');
    const qrImage = document.getElementById('qr-image');
    const qrLink = document.getElementById('qr-link');
    const qrOverlay = document.getElementById('qr-overlay');
    const qrLarge = document.getElementById('qr-large');
    const qrOverlayLink = document.getElementById('qr-overlay-link');
    const qrTrigger = document.getElementById('qr-trigger');

    let quizId = null;
    let timerId = null;
    let countdownId = null;
    let quizTitle = '';
    let totalQuestions = 0;

    function buildJoinUrl(code) {
      const url = new URL(window.location.origin + '/join.html');
      url.searchParams.set('quizId', code);
      url.searchParams.set('autoJoin', '1');
      url.searchParams.set('via', 'qr');
      return url.toString();
    }

    function updateQr(quizCode) {
      const joinUrl = buildJoinUrl(quizCode);
      const smallQr = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(joinUrl)}`;
      const largeQr = `https://api.qrserver.com/v1/create-qr-code/?size=360x360&data=${encodeURIComponent(joinUrl)}`;

      qrSection.classList.remove('hidden');
      qrImage.src = smallQr;
      qrImage.alt = `QR code for quiz ${quizCode}`;
      qrImage.dataset.large = largeQr;
      qrLink.textContent = joinUrl;
      qrOverlayLink.textContent = joinUrl;
      qrLarge.src = largeQr;
    }

    function saveHostCredentials(id) {
      sessionStorage.setItem('quizId', id);
    }

    function loadHostCredentials() {
      const params = new URLSearchParams(window.location.search);
      const storedQuizId = sessionStorage.getItem('quizId');
      quizCodeInput.value = params.get('quizId') || storedQuizId || '';
    }

    function renderLeaderboard(players) {
      leaderboardList.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('li');
        item.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        leaderboardList.appendChild(item);
      });
      playerCount.textContent = `${players.length} player${players.length === 1 ? '' : 's'}`;
    }

    function showMedia(media) {
      mediaPreview.innerHTML = '';
      if (!media) return;
      if (media.type === 'image') {
        mediaPreview.innerHTML = `<img src="${media.src}" alt="Question media" />`;
      } else if (media.type === 'audio') {
        mediaPreview.innerHTML = `<audio controls src="${media.src}"></audio>`;
      } else if (media.type === 'video') {
        mediaPreview.innerHTML = `<video controls src="${media.src}"></video>`;
      }
    }

    claimForm.addEventListener('submit', (event) => {
      event.preventDefault();
      claimError.textContent = '';
      socket.emit('host:claimHost', { quizId: quizCodeInput.value });
    });

    socket.on('host:claimed', ({ quizId: id, title, totalQuestions: total, questionDuration, leaderboard }) => {
      quizId = id;
      quizTitle = title;
      totalQuestions = total;
      saveHostCredentials(id);
      updateMeta(questionDuration);
      sessionCode.textContent = `Player session code: ${id}`;
      quizCodeInput.value = id;
      startQuestionBtn.disabled = false;
      endQuestionBtn.disabled = true;
      durationInput.value = questionDuration;
      renderLeaderboard(leaderboard);
      loopAudio.volume = 0.3;
      loopAudio.play().catch(() => {});
      updateQr(id);
    });

    socket.on('host:error', (message) => {
      claimError.textContent = message;
      sessionCode.textContent = '';
    });

    socket.on('host:playerJoined', (players) => {
      renderLeaderboard(players);
    });

    socket.on('leaderboard:update', (players) => {
      renderLeaderboard(players);
    });

    socket.on('quiz:durationChanged', ({ duration }) => {
      durationInput.value = duration;
      updateMeta(duration);
    });

    startQuestionBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:startQuestion', { quizId });
    });

    endQuestionBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:endQuestion', { quizId });
    });

    updateDurationBtn.addEventListener('click', () => {
      if (!quizId) return;
      socket.emit('host:updateDuration', { quizId, duration: durationInput.value });
    });

    socket.on('host:durationUpdated', ({ duration }) => {
      durationInput.value = duration;
      countdownBanner.textContent = `Updated: ${duration}s per question for upcoming rounds.`;
      updateMeta(duration);
      setTimeout(() => { countdownBanner.textContent = ''; }, 3000);
    });

    socket.on('question:start', ({ prompt, index, total, duration, media }) => {
      questionStatus.textContent = `Question ${index}/${total}: ${prompt}`;
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = false;
      questionStatus.classList.add('active');
      setTimeout(() => questionStatus.classList.remove('active'), 500);
      showMedia(media);
      countdown(duration);
      hideOverlay();
      stopCountdownBanner();
    });

    socket.on('question:end', ({ correctAnswer }) => {
      questionStatus.textContent = `Question ended. Correct answer: ${correctAnswer}`;
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      questionStatus.classList.remove('active');
      stopTimer();
      mediaPreview.innerHTML = '';
    });

    socket.on('leaderboard:show', ({ leaderboard, duration }) => {
      startQuestionBtn.disabled = true;
      renderOverlay(leaderboard, duration);
    });

    socket.on('quiz:finished', () => {
      questionStatus.textContent = 'Quiz complete! Share the leaderboard.';
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      stopTimer();
      loopAudio.pause();
    });

    socket.on('quiz:ended', () => {
      questionStatus.textContent = 'Quiz ended. Host disconnected or closed the game.';
      startQuestionBtn.disabled = true;
      endQuestionBtn.disabled = true;
      stopTimer();
      mediaPreview.innerHTML = '';
    });

    socket.on('quiz:countdown', ({ seconds }) => {
      startLobbyCountdown(seconds);
    });

    function countdown(seconds) {
      stopTimer();
      let remaining = seconds;
      timerId = setInterval(() => {
        if (remaining <= 0) {
          stopTimer();
          questionStatus.textContent = 'Time\'s up!';
          startQuestionBtn.disabled = true;
          endQuestionBtn.disabled = true;
          mediaPreview.innerHTML = '';
          return;
        }
        questionStatus.textContent = `${remaining}s left...`;
        remaining -= 1;
      }, 1000);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function updateMeta(duration) {
      quizMeta.textContent = `${quizTitle} · ${totalQuestions} question(s) · ${duration}s each`;
    }

    function renderOverlay(players, duration) {
      overlayList.innerHTML = '';
      players.forEach((player, index) => {
        const item = document.createElement('li');
        item.innerHTML = `<span>${index + 1}. ${player.name}</span><span>${player.score} pts</span>`;
        overlayList.appendChild(item);
      });
      overlay.classList.remove('hidden');
      overlayHint.textContent = duration ? `Next question in ${duration}s` : 'Quiz finished';
    }

    function hideOverlay() {
      overlay.classList.add('hidden');
      overlayList.innerHTML = '';
    }

    function startLobbyCountdown(seconds) {
      stopCountdownBanner();
      let remaining = seconds;
      countdownBanner.textContent = `Quiz starts automatically in ${remaining}s`;
      countdownId = setInterval(() => {
        remaining -= 1;
        countdownBanner.textContent = `Quiz starts automatically in ${Math.max(remaining, 0)}s`;
        if (remaining <= 0) stopCountdownBanner();
      }, 1000);
    }

    function stopCountdownBanner() {
      if (countdownId) {
        clearInterval(countdownId);
        countdownId = null;
      }
      countdownBanner.textContent = '';
    }

    qrTrigger.addEventListener('click', () => {
      if (!qrImage.dataset.large) return;
      qrOverlay.classList.remove('hidden');
    });

    qrOverlay.addEventListener('click', () => {
      qrOverlay.classList.add('hidden');
    });

    loadHostCredentials();
  </script>
</body>
</html>
